<!DOCTYPE html>

<html class="h-full" lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" name="viewport"/>
<title>Meeting Room Booking</title>
<script src="https://cdn.tailwindcss.com/3.4.17"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    * { 
      font-family: 'Kanit', sans-serif;
      box-sizing: border-box;
    }
    
    html, body { 
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    @media (max-width: 480px) {
      html { font-size: 13px; }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      html { font-size: 14px; }
    }
    @media (min-width: 769px) {
      html { font-size: 16px; }
    }

    .room-mind { background: linear-gradient(135deg, #F5D547 0%, #FFD700 100%); }
    .room-reality { background: linear-gradient(135deg, #FF2D55 0%, #FF1744 100%); }
    .room-power { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .room-space { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
    
    .room-mind-light { background: rgba(245, 213, 71, 0.15); border-left: 3px solid #F5D547; }
    .room-reality-light { background: rgba(255, 45, 85, 0.15); border-left: 3px solid #FF2D55; }
    .room-power-light { background: rgba(156, 39, 176, 0.15); border-left: 3px solid #9C27B0; }
    .room-space-light { background: rgba(33, 150, 243, 0.15); border-left: 3px solid #2196F3; }
    
    .booking-card { transition: all 0.2s ease; }
    .booking-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .modal-overlay { backdrop-filter: blur(4px); }
    
    .date-picker-day {
      padding: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: all 0.2s;
      border: 1px solid transparent;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 2rem;
    }
    .date-picker-day:hover { background: rgba(245, 213, 71, 0.1); }
    .date-picker-day.other-month { color: #cbd5e1; }
    .date-picker-day.selected { background: #F5D547; color: white; font-weight: 600; }
    .date-picker-day.today { border: 2px solid #F5D547; }
    
    .slide-in { animation: slideIn 0.3s ease; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cal-cell { min-height: 80px; }

    /* Month view: make day cells grow to fill available height */
    #calendar-container{ min-height:0; }
    .month-shell{ height:100%; display:flex; flex-direction:column; }
    .month-head{ flex-shrink:0; }
    .month-grid{ flex:1; min-height:0; display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr; }
    .month-grid .cal-cell{ min-height:0; }

    
    @media (max-width: 480px) {
      .cal-cell { min-height: 60px; }
    }
    @media (max-width: 768px) {
      .cal-cell { min-height: 70px; }
    }

    .attendee-badge {
      display: inline-block;
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      color: #0369a1;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .attendee-badge button {
      background: none;
      border: none;
      color: #0369a1;
      cursor: pointer;
      font-weight: bold;
      margin-left: 0.5rem;
    }
  </style>
<style>body { box-sizing: border-box; }</style>
</head>
<body class="h-full bg-slate-50 overflow-hidden">
<div class="h-full w-full flex flex-col" id="app"><!-- Header -->
<header class="bg-white border-b border-slate-200 px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between flex-shrink-0">
<div class="flex items-center gap-2 sm:gap-3 min-w-0">
<div class="w-8 h-8 sm:w-10 sm:h-10 room-mind rounded-lg sm:rounded-xl flex-shrink-0 flex items-center justify-center">
<svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
<div class="min-w-0 flex-1">
<h1 class="text-base sm:text-xl font-semibold text-slate-800 truncate" id="app-title">Meeting Room Booking</h1>
<p class="text-xs text-slate-500 hidden sm:block">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p>
</div>
</div><button class="bg-emerald-200 text-emerald-900 px-2 sm:px-4 py-2 rounded-lg font-medium flex items-center gap-1 sm:gap-2 hover:bg-emerald-300 transition text-xs sm:text-base whitespace-nowrap flex-shrink-0" onclick="openBookingModal()">
<svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="hidden sm:inline">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span> <span class="sm:hidden">‡∏à‡∏≠‡∏á</span> </button>
</header><!-- Navigation -->
<div class="bg-white border-b border-slate-200 px-2 sm:px-4 py-1.5 sm:py-2 flex items-center justify-between flex-shrink-0 overflow-x-auto">
<div class="flex items-center gap-1 sm:gap-2"><button class="p-1.5 sm:p-2 hover:bg-slate-100 rounded-lg transition flex-shrink-0" onclick="navigateMonth(-1)">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg></button> <button class="px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-medium text-emerald-900 bg-emerald-200 hover:bg-emerald-300 rounded-lg transition whitespace-nowrap" onclick="goToToday()">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button> <button class="p-1.5 sm:p-2 hover:bg-slate-100 rounded-lg transition flex-shrink-0" onclick="navigateMonth(1)">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg></button>
<h2 class="text-sm sm:text-lg font-semibold text-slate-800 ml-1 sm:ml-2 whitespace-nowrap" id="current-month"></h2>
</div>
<div class="flex items-center gap-1 sm:gap-2 flex-shrink-0"><select class="px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none" id="view-mode" onchange="changeView(this.value)"> <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option> <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option> <option value="day">‡∏ß‡∏±‡∏ô</option> </select> <select class="px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none" id="room-filter" onchange="filterByRoom(this.value)"> <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option> <option value="Mind Room">üü° Mind</option> <option value="Reality Room">üî¥ Reality</option> <option value="Power Room">üü£ Power</option> <option value="Space Room">üîµ Space</option> </select>
</div>
</div><!-- Room Legend -->
<div class="bg-white border-b border-slate-200 px-2 sm:px-4 py-1.5 flex items-center gap-2 sm:gap-4 flex-shrink-0 overflow-x-auto text-xs sm:text-sm"><span class="text-slate-500 flex-shrink-0">‡∏´‡πâ‡∏≠‡∏á:</span>
<div class="flex items-center gap-1 flex-shrink-0"><span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full room-mind"></span> <span class="text-slate-700">Mind</span>
</div>
<div class="flex items-center gap-1 flex-shrink-0"><span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full room-reality"></span> <span class="text-slate-700">Reality</span>
</div>
<div class="flex items-center gap-1 flex-shrink-0"><span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full room-power"></span> <span class="text-slate-700">Power</span>
</div>
<div class="flex items-center gap-1 flex-shrink-0"><span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full room-space"></span> <span class="text-slate-700">Space</span>
</div>
</div><!-- Calendar Container -->
<div class="flex-1 overflow-auto p-2 sm:p-4" id="calendar-container"><!-- Calendar will be rendered here -->
</div>
</div><!-- Booking Modal -->
<div class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50 p-2 sm:p-4" id="booking-modal">
<!-- Dialog -->
<div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden slide-in flex flex-col max-h-[90vh]">
<!-- Header -->
<div class="px-4 sm:px-6 py-4 border-b border-slate-200 bg-white flex items-center justify-between">
<div class="min-w-0">
<h3 class="text-lg sm:text-xl font-semibold text-slate-800 truncate" id="modal-title">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
<p class="text-xs text-slate-500 mt-0.5 hidden sm:block">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
</div>
<button aria-label="Close" class="p-2 hover:bg-slate-100 rounded-lg transition flex-shrink-0" onclick="closeBookingModal()" type="button">
<svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<!-- Body (scroll) -->
<form class="p-4 sm:p-6 overflow-y-auto flex-1 space-y-4" id="booking-form">
<input id="booking-id" type="hidden"/>
<input id="recurrence-group-id" type="hidden"/>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-title">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° <span class="text-red-500">*</span></label>
<input class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="booking-title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° Marketing" required="" type="text"/>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
<!-- Department first -->
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-department">‡πÅ‡∏ú‡∏ô‡∏Å <span class="text-red-500">*</span></label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="booking-department" required="">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
</select>
<p class="text-[11px] text-slate-500 mt-1">* ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-organizer">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á <span class="text-red-500">*</span></label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" disabled="" id="booking-organizer" required="">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>
</select>
<div class="mt-2">
<label class="block text-[11px] sm:text-xs font-medium text-slate-600 mb-1" for="booking-organizer-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
<input class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl bg-slate-50 text-slate-700 outline-none text-xs sm:text-sm" id="booking-organizer-email" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•" readonly="" type="text"/>
</div>
</div>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-2" for="fld_1">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° <span class="text-red-500">*</span></label>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
<label class="cursor-pointer" for="fld_1">
<input class="peer hidden" id="fld_1" name="room" required="" type="radio" value="Mind Room"/>
<div class="p-3 border-2 border-slate-200 rounded-xl peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition text-sm">
<div class="flex items-center gap-2">
<span class="w-4 h-4 rounded-full room-mind flex-shrink-0"></span>
<span class="font-medium text-slate-700">Mind Room</span>
</div>
</div>
</label>
<label class="cursor-pointer" for="fld_2">
<input class="peer hidden" id="fld_2" name="room" type="radio" value="Reality Room"/>
<div class="p-3 border-2 border-slate-200 rounded-xl peer-checked:border-red-500 peer-checked:bg-red-50 transition text-sm">
<div class="flex items-center gap-2">
<span class="w-4 h-4 rounded-full room-reality flex-shrink-0"></span>
<span class="font-medium text-slate-700">Reality Room</span>
</div>
</div>
</label>
<label class="cursor-pointer" for="fld_3">
<input class="peer hidden" id="fld_3" name="room" type="radio" value="Power Room"/>
<div class="p-3 border-2 border-slate-200 rounded-xl peer-checked:border-purple-500 peer-checked:bg-purple-50 transition text-sm">
<div class="flex items-center gap-2">
<span class="w-4 h-4 rounded-full room-power flex-shrink-0"></span>
<span class="font-medium text-slate-700">Power Room</span>
</div>
</div>
</label>
<label class="cursor-pointer" for="fld_4">
<input class="peer hidden" id="fld_4" name="room" type="radio" value="Space Room"/>
<div class="p-3 border-2 border-slate-200 rounded-xl peer-checked:border-blue-500 peer-checked:bg-blue-50 transition text-sm">
<div class="flex items-center gap-2">
<span class="w-4 h-4 rounded-full room-space flex-shrink-0"></span>
<span class="font-medium text-slate-700">Space Room</span>
</div>
</div>
</label>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-date-display">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></label>
<div class="relative">
<input class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none cursor-pointer bg-white text-sm" id="booking-date-display" onclick="toggleDatePicker()" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly="" required="" type="text"/>
<input id="booking-date" type="hidden"/>
<div class="hidden absolute top-full left-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-xl z-20 p-3 sm:p-4 w-72" id="date-picker">
<div class="flex items-center justify-between mb-3">
<button aria-label="Prev month" class="p-1.5 hover:bg-slate-100 rounded-lg transition" onclick="prevPickerMonth()" type="button">
<svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<div class="font-semibold text-slate-800 text-sm" id="picker-month-label"></div>
<button aria-label="Next month" class="p-1.5 hover:bg-slate-100 rounded-lg transition" onclick="nextPickerMonth()" type="button">
<svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="grid grid-cols-7 gap-0 mb-2 text-xs w-full">
<div class="text-center text-slate-500 font-medium py-3">‡∏≠‡∏≤</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏à</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏≠</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏û</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏û‡∏§</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏®</div>
<div class="text-center text-slate-500 font-medium py-3">‡∏™</div>
</div>
<div class="grid grid-cols-7 gap-0 w-full" id="date-picker-grid"></div>
</div>
</div>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="recurrence-type">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥</label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="recurrence-type">
<option value="none">‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</option>
<option value="daily">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>
<option value="weekly">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
<option value="biweekly">‡∏ó‡∏∏‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
<option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
</select>
</div>
</div>
<div class="hidden" id="recurrence-end-container">
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="recurrence-end-display">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥</label>
<div class="relative">
<input class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none cursor-pointer bg-white text-sm" id="recurrence-end-display" onclick="toggleRecurrencePicker()" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly="" type="text"/>
<input id="recurrence-end" type="hidden"/>
<div class="hidden absolute top-full left-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-xl z-20 p-3 sm:p-4 w-72" id="recurrence-picker">
<div class="flex items-center justify-between mb-3">
<button aria-label="Prev month" class="p-1.5 hover:bg-slate-100 rounded-lg transition" onclick="prevRecurrenceMonth()" type="button">
<svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<div class="font-semibold text-slate-800 text-sm" id="recurrence-month-label"></div>
<button aria-label="Next month" class="p-1.5 hover:bg-slate-100 rounded-lg transition" onclick="nextRecurrenceMonth()" type="button">
<svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="grid grid-cols-7 gap-1 mb-2 text-xs">
<div class="text-center text-slate-500 font-medium p-1">‡∏≠‡∏≤</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏à</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏≠</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏û</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏û‡∏§</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏®</div>
<div class="text-center text-slate-500 font-medium p-1">‡∏™</div>
</div>
<div class="grid grid-cols-7 gap-1" id="recurrence-picker-grid"></div>
</div>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-start">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span class="text-red-500">*</span></label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="booking-start" required=""></select>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-end">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="text-red-500">*</span></label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="booking-end" required=""></select>
</div>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-2" for="booking-description">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
<button class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100 transition flex items-center justify-center gap-2 text-slate-700 font-medium" onclick="openAttendeeModal()" type="button">
<svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span>
</button>
<div class="mt-3">
<div class="text-[11px] sm:text-xs text-slate-500 mb-1">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</div>
<div class="flex flex-wrap gap-2" id="attendees-display"></div>
</div>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="booking-description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
<textarea class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none resize-none text-sm" id="booking-description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." rows="3"></textarea>
</div>
<div class="hidden p-3 bg-red-50 border border-red-200 rounded-xl" id="conflict-warning">
<div class="flex items-center gap-2 text-red-700 text-sm">
<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span class="font-medium">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>
</div>
</div>
</form>
<!-- Footer -->
<div class="px-4 sm:px-6 py-4 border-t border-slate-200 bg-white flex gap-3">
<button class="flex-1 px-4 py-3 border border-slate-200 text-slate-700 rounded-xl font-medium hover:bg-slate-50 transition" onclick="closeBookingModal()" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
<button class="flex-1 px-4 py-3 bg-emerald-200 text-emerald-900 rounded-xl font-medium hover:bg-emerald-300 transition" form="booking-form" id="submit-btn" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>
</div>
</div>
<!-- Attendees Modal -->
<div class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50 p-2 sm:p-4" id="attendee-modal">
<div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden slide-in flex flex-col max-h-[90vh]">
<div class="px-4 sm:px-6 py-4 border-b border-slate-200 bg-white flex items-center justify-between">
<div class="min-w-0">
<h3 class="text-lg font-semibold text-slate-800 truncate">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
<p class="text-xs text-slate-500 mt-0.5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
</div>
<button aria-label="Close" class="p-2 hover:bg-slate-100 rounded-lg transition flex-shrink-0" onclick="closeAttendeeModal()" type="button">
<svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="p-4 sm:p-6 overflow-y-auto flex-1 space-y-4">
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="attendee-dept-filter">‡πÅ‡∏ú‡∏ô‡∏Å</label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="attendee-dept-filter">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
</select>
</div>
<div>
<label class="block text-xs sm:text-sm font-medium text-slate-700 mb-1" for="attendee-employee-select">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
<select class="w-full px-3 sm:px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-500 outline-none text-sm" id="attendee-employee-select">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° --</option>
</select>
<div class="mt-2 text-xs text-slate-600">
          ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: <span class="font-medium text-slate-800" id="attendee-email-preview">-</span>
</div>
</div>
<button class="w-full px-4 py-3 bg-blue-200 text-blue-900 rounded-xl font-medium hover:bg-blue-300 transition" onclick="addAttendeeFromModal()" type="button">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
<div>
<div class="text-xs text-slate-600 mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
<div class="flex flex-wrap gap-2" id="attendees-display-modal"></div>
</div>
</div>
<div class="px-4 sm:px-6 py-4 border-t border-slate-200 bg-white">
<button class="w-full px-4 py-3 bg-emerald-200 text-emerald-900 rounded-xl font-medium hover:bg-emerald-300 transition" onclick="closeAttendeeModal()" type="button">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
</div>
</div>
</div>
<!-- View Booking Modal -->
<div class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50 p-2 sm:p-4" id="view-modal">
<div class="bg-white rounded-2xl w-full max-w-md slide-in">
<div class="p-3 sm:p-6 rounded-t-2xl" id="view-modal-header">
<div class="flex items-center justify-between">
<h3 class="text-base sm:text-xl font-semibold text-white truncate" id="view-title"></h3><button class="p-1.5 sm:p-2 hover:bg-white/20 rounded-lg transition flex-shrink-0" onclick="closeViewModal()">
<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg></button>
</div>
</div>
<div class="p-3 sm:p-6 space-y-3 sm:space-y-4">
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="text-slate-700" id="view-room"></span>
</div>
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="text-slate-700" id="view-date"></span>
</div>
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="text-slate-700" id="view-time"></span>
</div>
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base" id="view-organizer-container">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<div>
<div class="text-slate-500">
        ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
       </div><span class="text-slate-700 font-medium" id="view-organizer"></span>
</div>
</div>
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base" id="view-dept-container">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<div>
<div class="text-slate-500">
        ‡πÅ‡∏ú‡∏ô‡∏Å
       </div><span class="text-slate-700 font-medium" id="view-dept"></span>
</div>
</div>
<div class="flex items-center gap-2 sm:gap-3 text-xs sm:text-base" id="view-recurrence-container">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="text-slate-700" id="view-recurrence"></span>
</div>
<div class="flex items-start gap-2 sm:gap-3 text-xs sm:text-base" id="view-attendees-container">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<div class="text-slate-700" id="view-attendees"></div>
</div>
<div class="flex items-start gap-2 sm:gap-3 text-xs sm:text-base" id="view-description-container">
<svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="text-slate-700" id="view-description"></span>
</div>
<div class="flex gap-2 sm:gap-3 pt-2 sm:pt-4"><button class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 border border-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-50 transition flex items-center justify-center gap-2 text-xs sm:text-base" onclick="editBooking()">
<svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="hidden sm:inline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span> </button> <button class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition flex items-center justify-center gap-2 text-xs sm:text-base" id="delete-btn" onclick="showDeleteConfirm()">
<svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg><span class="hidden sm:inline">‡∏•‡∏ö</span> </button>
</div>
<div class="hidden pt-2" id="delete-confirm">
<div class="p-2 sm:p-3 bg-red-50 border border-red-200 rounded-lg">
<p class="text-xs sm:text-sm text-red-700 mb-2 sm:mb-3">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
<div class="space-y-1 sm:space-y-2" id="delete-options"><button class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white border border-red-200 text-red-700 rounded-lg hover:bg-red-50 transition" onclick="deleteBooking('single')">‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button> <button class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition" id="delete-all-btn" onclick="deleteBooking('all')">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div><button class="w-full mt-1 sm:mt-2 px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition" onclick="hideDeleteConfirm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div>
</div>
</div>
</div><!-- Attendees Modal -->
<!-- Toast -->
<div class="fixed bottom-4 right-4 bg-slate-800 text-white px-3 sm:px-4 py-2 sm:py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 text-xs sm:text-sm max-w-xs" id="toast"><span id="toast-message"></span>
</div>
<script>

    // =========================
    // Google Apps Script Backend
    // =========================
    const API_KEY_EXPECTED = "ESS-ROOM-2026";
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyLp9bB6QHjPZ8KRf1FqGJ5am-ubfJqHE2pxgCxX_szEHnOEX8wjlIukDCupjOmC9wSow/exec";

    // Employees JSON (GitHub raw)
    const EMPLOYEES_JSON_URL = "https://raw.githubusercontent.com/itmappointasia/ESS/main/%E0%B8%82%E0%B9%89%E0%B8%AD%E0%B8%A1%E0%B8%B9%E0%B8%A5%E0%B8%9E%E0%B8%99%E0%B8%B1%E0%B8%81%E0%B8%87%E0%B8%B2%E0%B8%99.json";
// JSONP helper (‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS ‡πÉ‡∏ô WebApp)
    function callJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const sep = url.includes("?") ? "&" : "?";
        const full = url + sep + "callback=" + cb;

        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("Request timeout"));
        }, 25000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        window[cb] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("Network error"));
        };

        script.src = full;
        document.body.appendChild(script);
      });
    }

    async function api(action, params = {}) {
      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", action);
      url.searchParams.set("apiKey", API_KEY_EXPECTED);

      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null) return;
        url.searchParams.set(k, typeof v === "string" ? v : JSON.stringify(v));
      });

      const res = await callJSONP(url.toString());
      if (!res || res.ok !== true) {
        const msg = (res && (res.error || res.message)) ? (res.error || res.message) : "Backend error";
        throw new Error(msg);
      }
      return res;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function loadEmployeesFromGitHub(){
      const res = await fetch(EMPLOYEES_JSON_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error("JSON must be an array");
      // Normalize: allow either {name,email,department} or Thai header keys
      const out = [];
      for(const e of data){
        const name = (e.name ?? e["‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"] ?? e["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"] ?? e["‡∏ä‡∏∑‡πà‡∏≠"] ?? "").toString().trim();
        const email = (e.email ?? e["‡∏≠‡∏µ‡πÄ‡∏°‡∏•"] ?? e["Email"] ?? "").toString().trim();
        const department = (e.department ?? e["‡πÅ‡∏ú‡∏ô‡∏Å"] ?? e["Dept"] ?? e["Department"] ?? "").toString().trim();
        if(!name) continue;
        out.push({ name, email, department });
      }
      return out;
    }

    async function loadEmployeesWithFallback(){
      try {
        return await loadEmployeesFromGitHub();
      } catch (e) {
        // fallback to Apps Script (useful if GitHub blocked)
        const empRes = await api("getEmployees");
        return (empRes.data || []);
      }
    }

    let bookings = [];

    let currentDate = new Date();
    let currentView = 'month';
    let currentRoomFilter = 'all';
    let selectedBooking = null;
    let isEditing = false;
    let pickerDate = new Date();
    let recurrencePickerDate = new Date();
    let attendeesList = [];

    const defaultConfig = {
      app_title: 'Meeting Room Booking'
    };

    const employees = []; // {name,email,department}
    let departments = []; // unique list from employees


    const roomColors = {
      'Mind Room': { class: 'room-mind', light: 'room-mind-light' },
      'Reality Room': { class: 'room-reality', light: 'room-reality-light' },
      'Power Room': { class: 'room-power', light: 'room-power-light' },
      'Space Room': { class: 'room-space', light: 'room-space-light' }
    };

    const timeOptions = [];
    // 07:30 -> 18:30 (step 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
    (function buildTimes(){
      const startMin = 7*60 + 30;
      const endMin   = 18*60 + 30;
      for (let t = startMin; t <= endMin; t += 30) {
        const h = Math.floor(t/60);
        const m = t%60;
        timeOptions.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
      }
    })();


    const recurrenceLabels = {
      'none': '‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥',
      'daily': '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
      'weekly': '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
      'biweekly': '‡∏ó‡∏∏‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
      'monthly': '‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
    };

    const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                       '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

    function initTimeSelects() {
      const startSelect = document.getElementById('booking-start');
      const endSelect = document.getElementById('booking-end');
      
      startSelect.innerHTML = timeOptions.map(t => `<option value="${t}">${t}</option>`).join('');
      endSelect.innerHTML = timeOptions.map(t => `<option value="${t}">${t}</option>`).join('');
      
      startSelect.value = '09:00';
      endSelect.value = '10:00';
    }

    function initOrganizerSelect() {
      const deptSelect = document.getElementById('booking-department');
      const organizerSelect = document.getElementById('booking-organizer');
      const organizerEmailInput = document.getElementById('booking-organizer-email');

      const attendeeDeptSelect = document.getElementById('attendee-dept-filter');
      const attendeeEmpSelect = document.getElementById('attendee-employee-select');

      // Unique departments
      departments = Array.from(new Set(employees.map(e => e.department).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,'th'));

      // Populate department selects
      deptSelect.innerHTML =
        '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>' +
        departments.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');

      attendeeDeptSelect.innerHTML =
        '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>' +
        departments.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');

      // Disable organizer until department selected
      organizerSelect.disabled = true;
      organizerSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>';
      organizerEmailInput.value = '';

      // When department changes -> filter organizer names
      deptSelect.addEventListener('change', () => {
        const dept = deptSelect.value;
        organizerSelect.value = '';
        organizerEmailInput.value = '';

        if (!dept) {
          organizerSelect.disabled = true;
          organizerSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>';
          return;
        }

        const emps = employees.filter(e => (e.department || '') === dept)
          .sort((a,b)=>a.name.localeCompare(b.name,'th'));

        organizerSelect.disabled = false;
        organizerSelect.innerHTML =
          '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>' +
          emps.map(e => `<option value="${escapeHtml(e.name)}">${escapeHtml(e.name)}</option>`).join('');
      });

      // organizer -> auto fill email
      organizerSelect.addEventListener('change', () => {
        const name = organizerSelect.value;
        const emp = employees.find(x => x.name === name);
        organizerEmailInput.value = emp?.email || '';
      });

      // Attendee modal: dept -> filter employees
      attendeeDeptSelect.addEventListener('change', () => {
        const dept = attendeeDeptSelect.value;
        attendeeEmpSelect.value = '';
        document.getElementById('attendee-email-preview').textContent = '-';

        if (!dept) {
          attendeeEmpSelect.disabled = true;
          attendeeEmpSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>';
          return;
        }

        const emps = employees.filter(e => (e.department || '') === dept)
          .sort((a,b)=>a.name.localeCompare(b.name,'th'));

        attendeeEmpSelect.disabled = false;
        attendeeEmpSelect.innerHTML =
          '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° --</option>' +
          emps.map(e => `<option value="${escapeHtml(e.name)}">${escapeHtml(e.name)}</option>`).join('');
      });

      attendeeEmpSelect.addEventListener('change', () => {
        const name = attendeeEmpSelect.value;
        const emp = employees.find(x => x.name === name);
        document.getElementById('attendee-email-preview').textContent = emp?.email || '-';
      });
    }

    async function bootstrapFromBackend() {
      try {
        // Employees (prefer GitHub JSON; fallback to Apps Script if needed)
        const empList = await loadEmployeesWithFallback();
        employees.length = 0;
        (empList || []).forEach(e => employees.push(e));

        initOrganizerSelect();

        // Bookings
        const bookRes = await api('getBookings');
        bookings = (bookRes.data || []).map(b => ({
          ...b,
          __backendId: b.id || b.__backendId
        }));

        renderCalendar();
      } catch (err) {
        console.error(err);
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || err));
      }
    }

async function refreshBookings() {
      const bookRes = await api('getBookings');
      bookings = (bookRes.data || []).map(b => ({
        ...b,
        __backendId: b.id || b.__backendId
      }));
      renderCalendar();
    }

async function init() {
      try {
        initTimeSelects();
        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏°‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï)
        renderCalendar();
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡∏ú‡πà‡∏≤‡∏ô Apps Script
        await bootstrapFromBackend();
      } catch (e) {
        console.error(e);
      }
    }

    // -----------------------
    // DOM Ready: bind listeners + start app
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const rt = document.getElementById('recurrence-type');
        if (rt) {
          rt.addEventListener('change', function() {
            const container = document.getElementById('recurrence-end-container');
            if (!container) return;
            if (this.value !== 'none') container.classList.remove('hidden');
            else container.classList.add('hidden');
          });
        }

        const form = document.getElementById('booking-form');
        if (form) form.addEventListener('submit', handleBookingSubmit);

        ['booking-date', 'booking-start', 'booking-end'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', checkConflict);
        });

        document.querySelectorAll('input[name="room"]').forEach(input => {
          input.addEventListener('change', checkConflict);
        });

        document.addEventListener('click', function(e) {
          if (!e.target.closest('.relative')) {
            const dp = document.getElementById('date-picker');
            if (dp) dp.classList.add('hidden');
          }
        });

        // Start app
        init();
      } catch (e) {
        console.error(e);
      }
    });



    function openAttendeeModal() {
      const modal = document.getElementById('attendee-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeAttendeeModal() {
      const modal = document.getElementById('attendee-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function addAttendeeFromModal() {
      const select = document.getElementById('attendee-employee-select');
      const name = select.value;

      if (!name) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°');
        return;
      }

      const emp = employees.find(x => x.name === name);
      const email = emp?.email || '';

      if (attendeesList.some(a => a.name === name)) {
        showToast('‡∏ú‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
        return;
      }

      attendeesList.push({ name, email });
      updateAttendeesDisplay();

      // reset selection
      select.value = '';
      document.getElementById('attendee-email-preview').textContent = '-';
    }


function removeAttendee(index) {
      attendeesList.splice(index, 1);
      updateAttendeesDisplay();
    }

    function updateAttendeesDisplay() {
      const display = document.getElementById('attendees-display');
      display.innerHTML = attendeesList.map((a, index) => `
        <span class="attendee-badge" title="${escapeHtml(a.email || '')}">
          ${escapeHtml(a.name)}
          <button type="button" onclick="removeAttendee(${index}); event.preventDefault();">‚úï</button>
        </span>
      `).join('');
    }

    function toggleDatePicker() {
      const picker = document.getElementById('date-picker');
      picker.classList.toggle('hidden');
      if (!picker.classList.contains('hidden')) {
        updatePickerMonth();
      }
    }

    function updatePickerMonth() {
      const year = pickerDate.getFullYear();
      const month = pickerDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const totalDays = lastDay.getDate();
      const today = new Date();
      const selectedDate = document.getElementById('booking-date').value;

      document.getElementById('picker-month-label').textContent = `${thaiMonths[month]} ${year + 543}`;

      let html = '';
      
      for (let i = 0; i < startDay; i++) {
        html += `<div class="date-picker-day other-month"></div>`;
      }

      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
        const isSelected = selectedDate === dateStr;

        let classes = 'date-picker-day';
        if (isSelected) classes += ' selected';
        if (isToday) classes += ' today';

        html += `
          <button type="button" class="${classes}" onclick="selectDate('${dateStr}'); event.preventDefault();">
            ${day}
          </button>
        `;
      }

      const remainingCells = (7 - ((startDay + totalDays) % 7)) % 7;
      for (let i = 0; i < remainingCells; i++) {
        html += `<div class="date-picker-day other-month"></div>`;
      }

      document.getElementById('date-picker-grid').innerHTML = html;
    }

    function prevPickerMonth() {
      pickerDate.setMonth(pickerDate.getMonth() - 1);
      updatePickerMonth();
    }

    function nextPickerMonth() {
      pickerDate.setMonth(pickerDate.getMonth() + 1);
      updatePickerMonth();
    }

    function selectDate(dateStr) {
      document.getElementById('booking-date').value = dateStr;
      document.getElementById('booking-date-display').value = formatDateDisplay(dateStr);
      document.getElementById('date-picker').classList.add('hidden');
      checkConflict();
    }

    function formatDateDisplay(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${parseInt(day)} ${thaiMonths[parseInt(month) - 1]} ${parseInt(year) + 543}`;
    }

    function toggleRecurrencePicker(forceOpen = null) {
      const picker = document.getElementById('recurrence-picker');
      const btn = document.getElementById('recurrence-end-display');
      if (!picker || !btn) return;

      // Always close the main date picker when opening recurrence picker (avoid overlap)
      const mainPicker = document.getElementById('date-picker');
      if (mainPicker) mainPicker.classList.add('hidden');

      const willOpen = (forceOpen === true) ? true : (forceOpen === false) ? false : picker.classList.contains('hidden');

      if (!willOpen) {
        picker.classList.add('hidden');
        return;
      }

      // init month cursor from selected recurrence end, else from booking date, else today
      const endVal = (document.getElementById('recurrence-end')?.value || '').trim();
      const bookingVal = (document.getElementById('booking-date')?.value || '').trim();
      let base = null;

      if (endVal && /^\d{4}-\d{2}-\d{2}$/.test(endVal)) base = new Date(endVal + 'T00:00:00');
      else if (bookingVal && /^\d{4}-\d{2}-\d{2}$/.test(bookingVal)) base = new Date(bookingVal + 'T00:00:00');
      else base = new Date();

      // month cursor (1st day of month)
      window.recurrencePickerDate = new Date(base.getFullYear(), base.getMonth(), 1);

      // keep selected value for highlight
      window.selectedRecurrenceEnd = endVal;

      picker.classList.remove('hidden');
      updateRecurrencePickerMonth();

      // Position picker under the button (within modal)
      try {
        const container = btn.closest('.field');
        if (container) {
          picker.style.left = '0px';
          picker.style.top = (btn.offsetTop + btn.offsetHeight + 8) + 'px';
        }
      } catch(e){}

      // Close on outside click
      if (!window.__recurrenceOutsideClickBound) {
        window.__recurrenceOutsideClickBound = true;
        document.addEventListener('mousedown', (ev) => {
          const p = document.getElementById('recurrence-picker');
          const b = document.getElementById('recurrence-end-display');
          if (!p || p.classList.contains('hidden')) return;
          if (p.contains(ev.target) || (b && b.contains(ev.target))) return;
          p.classList.add('hidden');
        });
      }
    }

    function prevRecurrenceMonth() {
      if (!window.recurrencePickerDate) window.recurrencePickerDate = new Date();
      window.recurrencePickerDate.setMonth(window.recurrencePickerDate.getMonth() - 1);
      window.recurrencePickerDate.setDate(1);
      updateRecurrencePickerMonth();
    }

    function nextRecurrenceMonth() {
      if (!window.recurrencePickerDate) window.recurrencePickerDate = new Date();
      window.recurrencePickerDate.setMonth(window.recurrencePickerDate.getMonth() + 1);
      window.recurrencePickerDate.setDate(1);
      updateRecurrencePickerMonth();
    }

    function updateRecurrencePickerMonth() {
      const label = document.getElementById('recurrence-month-label');
      const grid = document.getElementById('recurrence-picker-grid');
      if (!label || !grid) return;

      const d = window.recurrencePickerDate || new Date();
      const year = d.getFullYear();
      const month = d.getMonth(); // 0-11

      label.textContent = thaiMonths[month] + ' ' + year;

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startDay = first.getDay(); // 0=Sun
      const daysInMonth = last.getDate();

      // min end date = booking date (can't end before first occurrence)
      const bookingVal = (document.getElementById('booking-date')?.value || '').trim();
      const minDate = (bookingVal && /^\d{4}-\d{2}-\d{2}$/.test(bookingVal)) ? new Date(bookingVal + 'T00:00:00') : null;

      grid.innerHTML = '';

      // leading blanks
      for (let i=0; i<startDay; i++){
        const cell = document.createElement('div');
        grid.appendChild(cell);
      }

      // day buttons
      for (let day=1; day<=daysInMonth; day++){
        const cur = new Date(year, month, day);
        const ymd = cur.toISOString().slice(0,10);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = String(day);
        btn.className = 'h-9 w-9 rounded-lg text-sm font-medium hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500';

        const isBeforeMin = minDate && cur.getTime() < minDate.getTime();
        if (isBeforeMin) {
          btn.disabled = true;
          btn.className = 'h-9 w-9 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed';
        } else {
          btn.addEventListener('click', () => setRecurrenceEndDate(ymd));
        }

        if (window.selectedRecurrenceEnd && window.selectedRecurrenceEnd === ymd) {
          btn.className = 'h-9 w-9 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500';
        }

        grid.appendChild(btn);
      }
    }

    function setRecurrenceEndDate(ymd) {
      const hidden = document.getElementById('recurrence-end');
      const display = document.getElementById('recurrence-end-display');
      const picker = document.getElementById('recurrence-picker');
      if (!hidden || !display) return;

      hidden.value = ymd;
      display.value = formatDateDisplay(ymd);
      window.selectedRecurrenceEnd = ymd;

      if (picker) picker.classList.add('hidden');
    }


    function navigateMonth(direction) {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + direction);
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction * 7));
      } else {
        currentDate.setDate(currentDate.getDate() + direction);
      }
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    function changeView(view) {
      currentView = view;
      renderCalendar();
    }

    function filterByRoom(room) {
      currentRoomFilter = room;
      renderCalendar();
    }

    function getFilteredBookings() {
      let filtered = bookings;
      
      if (currentRoomFilter !== 'all') {
        filtered = filtered.filter(b => b.room === currentRoomFilter);
      }
      
      return filtered;
    }

    function renderCalendar() {
      const container = document.getElementById('calendar-container');
      const monthLabel = document.getElementById('current-month');
      
      const thaiDays = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];

      if (currentView === 'month') {
        monthLabel.textContent = `${thaiMonths[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
        container.innerHTML = renderMonthView(thaiDays);
      } else if (currentView === 'week') {
        const weekStart = getWeekStart(currentDate);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        monthLabel.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${thaiMonths[weekEnd.getMonth()]} ${weekEnd.getFullYear() + 543}`;
        container.innerHTML = renderWeekView();
      } else {
        monthLabel.textContent = `${currentDate.getDate()} ${thaiMonths[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
        container.innerHTML = renderDayView();
      }
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      return d;
    }

    function renderMonthView(thaiDays) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const totalDays = lastDay.getDate();
      const today = new Date();

      let html = `
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden month-shell">
          <div class="grid bg-slate-50 border-b border-slate-200 month-head" style="grid-template-columns: repeat(7, 1fr);">
            ${thaiDays.map(d => `<div class="p-2 sm:p-3 text-center text-xs sm:text-sm font-medium text-slate-600">${d}</div>`).join('')}
          </div>
          <div class="month-grid" style="grid-template-columns: repeat(7, 1fr);">
      `;

      for (let i = 0; i < startDay; i++) {
        html += `<div class="cal-cell p-2 sm:p-3 border-b border-r border-slate-100 bg-slate-50"></div>`;
      }

      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
        const dayBookings = getFilteredBookings().filter(b => b.date === dateStr);

        html += `
          <div class="cal-cell p-2 sm:p-3 border-b border-r border-slate-100 hover:bg-slate-50 transition cursor-pointer overflow-hidden" onclick="openBookingModal('${dateStr}')">
            <div class="flex items-center justify-between mb-1">
              <span class="${isToday ? 'w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded-full bg-emerald-200 text-emerald-900 text-xs sm:text-sm font-medium' : 'text-xs sm:text-sm text-slate-700 font-medium'}">${day}</span>
            </div>
            <div class="space-y-0.5 text-xs">
              ${dayBookings.slice(0, 2).map(b => `
                <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')" class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-1.5 sm:px-2 py-0.5 sm:py-1 rounded truncate cursor-pointer">
                  <span class="font-medium">${b.start_time}</span> <span class="hidden sm:inline">${b.title}</span><span class="sm:hidden">...</span>
                </div>
              `).join('')}
              ${dayBookings.length > 2 ? `<div class="text-slate-500 pl-1.5 sm:pl-2">+${dayBookings.length - 2}</div>` : ''}
            </div>
          </div>
        `;
      }

      const remainingCells = (7 - ((startDay + totalDays) % 7)) % 7;
      for (let i = 0; i < remainingCells; i++) {
        html += `<div class="cal-cell p-2 sm:p-3 border-b border-r border-slate-100 bg-slate-50"></div>`;
      }

      html += `</div></div>`;
      return html;
    }

    function renderWeekView() {
      const weekStart = getWeekStart(currentDate);
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
      const thaiDaysFull = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

      let html = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">`;
      
      html += `<div class="grid border-b border-slate-200 bg-slate-50 flex-shrink-0 overflow-x-auto" style="grid-template-columns: 50px repeat(7, 1fr);">`;
      html += `<div class="p-2 sm:p-3 text-center text-xs sm:text-sm font-medium text-slate-600 border-r border-slate-200">‡πÄ‡∏ß‡∏•‡∏≤</div>`;
      
      for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        const dateStr = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        html += `
          <div class="p-1.5 sm:p-3 text-center border-r border-slate-200 ${isToday ? 'bg-emerald-50' : ''} text-xs">
            <div class="text-slate-500 font-medium">${thaiDaysFull[i]}</div>
            <div class="${isToday ? 'w-7 h-7 mx-auto flex items-center justify-center rounded-full bg-emerald-200 text-emerald-900 font-semibold text-xs' : 'font-semibold text-slate-700'}">${d.getDate()}</div>
          </div>
        `;
      }
      html += `</div>`;

      html += `<div class="overflow-y-auto flex-1">`;
      for (let h = 7; h <= 20; h++) {
        html += `<div class="grid border-b border-slate-100" style="grid-template-columns: 50px repeat(7, 1fr);">`;
        html += `<div class="p-1.5 sm:p-2 text-xs text-slate-500 text-center border-r border-slate-100 bg-slate-50 flex-shrink-0">${h.toString().padStart(2, '0')}:00</div>`;
        
        for (let i = 0; i < 7; i++) {
          const d = new Date(weekStart);
          d.setDate(d.getDate() + i);
          const dateStr = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
          const hourBookings = getFilteredBookings().filter(b => {
            if (b.date !== dateStr) return false;
            const startHour = parseInt(b.start_time.split(':')[0]);
            return startHour === h;
          });

          html += `
            <div class="p-0.5 sm:p-1 min-h-[50px] sm:min-h-[60px] border-r border-slate-100" onclick="openBookingModal('${dateStr}', '${h.toString().padStart(2, '0')}:00')">
              ${hourBookings.map(b => `
                <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')" class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-1 sm:px-2 py-0.5 sm:py-1 rounded text-xs mb-0.5 cursor-pointer">
                  <div class="font-medium truncate">${b.title}</div>
                  <div class="text-slate-500 text-xs">${b.start_time}</div>
                </div>
              `).join('')}
            </div>
          `;
        }
        html += `</div>`;
      }
      html += `</div></div>`;

      return html;
    }

    function renderDayView() {
      const dateStr = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;
      const rooms = ['Mind Room', 'Reality Room', 'Power Room', 'Space Room'];
      const filteredRooms = currentRoomFilter === 'all' ? rooms : [currentRoomFilter];

      let html = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">`;
      
      html += `<div class="grid border-b border-slate-200 bg-slate-50 flex-shrink-0" style="grid-template-columns: 50px repeat(${filteredRooms.length}, 1fr);">`;
      html += `<div class="p-2 sm:p-3 text-center text-xs sm:text-sm font-medium text-slate-600 border-r border-slate-200">‡πÄ‡∏ß‡∏•‡∏≤</div>`;
      
      filteredRooms.forEach(room => {
        html += `
          <div class="p-1.5 sm:p-3 text-center border-r border-slate-200 text-xs">
            <div class="flex items-center justify-center gap-1 mb-1">
              <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full ${roomColors[room].class}"></span>
            </div>
            <span class="font-medium text-slate-700 hidden sm:inline">${room}</span>
            <span class="font-medium text-slate-700 sm:hidden">${room.split(' ')[0]}</span>
          </div>
        `;
      });
      html += `</div>`;

      html += `<div class="overflow-y-auto flex-1">`;
      for (let h = 7; h <= 20; h++) {
        html += `<div class="grid border-b border-slate-100" style="grid-template-columns: 50px repeat(${filteredRooms.length}, 1fr);">`;
        html += `<div class="p-1.5 sm:p-2 text-xs text-slate-500 text-center border-r border-slate-100 bg-slate-50 flex-shrink-0">${h.toString().padStart(2, '0')}:00</div>`;
        
        filteredRooms.forEach(room => {
          const hourBookings = bookings.filter(b => {
            if (b.date !== dateStr || b.room !== room) return false;
            const startHour = parseInt(b.start_time.split(':')[0]);
            return startHour === h;
          });

          html += `
            <div class="p-0.5 sm:p-1 min-h-[50px] sm:min-h-[60px] border-r border-slate-100" onclick="openBookingModal('${dateStr}', '${h.toString().padStart(2, '0')}:00', '${room}')">
              ${hourBookings.map(b => `
                <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')" class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-1 sm:px-2 py-0.5 sm:py-1 rounded text-xs mb-0.5 cursor-pointer">
                  <div class="font-medium truncate">${b.title}</div>
                  <div class="text-slate-500 text-xs">${b.start_time}</div>
                </div>
              `).join('')}
            </div>
          `;
        });
        html += `</div>`;
      }
      html += `</div></div>`;

      return html;
    }

    function openBookingModal(date = null, time = null, room = null) {
      isEditing = false;
      document.getElementById('modal-title').textContent = '‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°';
      document.getElementById('booking-form').reset();
      // reset department filter -> show all employees each time modal opens
      const __deptSel = document.getElementById('booking-department');
      if (__deptSel) { __deptSel.value = ''; __deptSel.dispatchEvent(new Event('change')); }
      document.getElementById('booking-id').value = '';
      document.getElementById('recurrence-group-id').value = '';
      document.getElementById('conflict-warning').classList.add('hidden');
      document.getElementById('recurrence-end-container').classList.add('hidden');
      const re = document.getElementById('recurrence-end'); if (re) { re.value=''; re.required=false; }
      const reDisp = document.getElementById('recurrence-end-display'); if (reDisp) reDisp.value='';
      document.getElementById('date-picker').classList.add('hidden');
      attendeesList = [];
      updateAttendeesDisplay();
      
      if (date) {
        document.getElementById('booking-date').value = date;
        document.getElementById('booking-date-display').value = formatDateDisplay(date);
        pickerDate = new Date(date);
      } else {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('booking-date').value = today;
        document.getElementById('booking-date-display').value = formatDateDisplay(today);
        pickerDate = new Date();
      }
      
      if (time) {
        document.getElementById('booking-start').value = time;
        const endHour = parseInt(time.split(':')[0]) + 1;
        document.getElementById('booking-end').value = `${endHour.toString().padStart(2, '0')}:00`;
      } else {
        document.getElementById('booking-start').value = '09:00';
        document.getElementById('booking-end').value = '10:00';
      }
      
      if (room) {
        const radioBtn = document.querySelector(`input[name="room"][value="${room}"]`);
        if (radioBtn) radioBtn.checked = true;
      }
      
      document.getElementById('booking-modal').classList.remove('hidden');
      document.getElementById('booking-modal').classList.add('flex');
    }

    function closeBookingModal() {
      document.getElementById('booking-modal').classList.add('hidden');
      document.getElementById('booking-modal').classList.remove('flex');
      document.getElementById('date-picker').classList.add('hidden');
      attendeesList = [];
    }

    function checkConflict() {
      const date = document.getElementById('booking-date').value;
      const start = document.getElementById('booking-start').value;
      const end = document.getElementById('booking-end').value;
      const room = document.querySelector('input[name="room"]:checked')?.value;
      const currentId = document.getElementById('booking-id').value;

      if (!date || !start || !end || !room) {
        document.getElementById('conflict-warning').classList.add('hidden');
        return false;
      }

      const hasConflict = bookings.some(b => {
        if (b.__backendId === currentId) return false;
        if (b.date !== date || b.room !== room) return false;
        
        const bStart = b.start_time;
        const bEnd = b.end_time;
        
        return (start < bEnd && end > bStart);
      });

      if (hasConflict) {
        document.getElementById('conflict-warning').classList.remove('hidden');
      } else {
        document.getElementById('conflict-warning').classList.add('hidden');
      }

      return hasConflict;
    }

    function generateRecurrenceDates(startDate, endDate, type) {
      const dates = [];
      const start = new Date(startDate);
      const end = new Date(endDate);
      let current = new Date(start);

      while (current <= end) {
        dates.push(current.toISOString().split('T')[0]);
        
        switch(type) {
          case 'daily':
            current.setDate(current.getDate() + 1);
            break;
          case 'weekly':
            current.setDate(current.getDate() + 7);
            break;
          case 'biweekly':
            current.setDate(current.getDate() + 14);
            break;
          case 'monthly':
            current.setMonth(current.getMonth() + 1);
            break;
        }
      }

      return dates;
    }

    async function handleBookingSubmit(e) {
      e.preventDefault();

      if (checkConflict()) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
        return;
      }

      if (bookings.length >= 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>‚è≥</span>';

      const id = document.getElementById('booking-id').value;
      const title = document.getElementById('booking-title').value.trim();
      const organizerName = document.getElementById('booking-organizer').value;
      const organizerEmail = document.getElementById('booking-organizer-email').value.trim();
      const department = document.getElementById('booking-department').value;
      const room = document.querySelector('input[name="room"]:checked')?.value || '';
      const date = document.getElementById('booking-date').value;
      const startTime = document.getElementById('booking-start').value;
      const endTime = document.getElementById('booking-end').value;
      const recurrenceType = document.getElementById('recurrence-type').value;
      const recurrenceEnd = document.getElementById('recurrence-end').value;
      const description = document.getElementById('booking-description').value || '';

      const attendeesNames = attendeesList.map(a => a.name).join('; ');
      const attendeesEmails = attendeesList.map(a => a.email).filter(Boolean).join('; ');

      const basePayload = {
        title,
        organizer_name: organizerName,
        organizer_email: organizerEmail,
        department,
        room,
        date,
        start_time: startTime,
        end_time: endTime,
        attendees_names: attendeesNames,
        attendees_emails: attendeesEmails,
        description,
        recurrence_type: recurrenceType || 'none',
        recurrence_end: recurrenceEnd || '',
        recurrence_group_id: document.getElementById('recurrence-group-id').value || ''
      };

      try {
        if (id && isEditing) {
          await api('updateBooking', { id, booking: { ...basePayload, id } });
          showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } else {
          if (recurrenceType !== 'none' && recurrenceEnd) {
            const dates = generateRecurrenceDates(date, recurrenceEnd, recurrenceType);
            const groupId = Date.now().toString();

            for (const d of dates) {
              if (bookings.length >= 999) break;
              await api('createBooking', {
                booking: {
                  ...basePayload,
                  id: `${groupId}-${d}`,
                  date: d,
                  recurrence_group_id: groupId
                }
              });
            }
            showToast(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥ ${dates.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
          } else {
            await api('createBooking', {
              booking: {
                ...basePayload,
                id: Date.now().toString(),
                recurrence_type: 'none',
                recurrence_end: '',
                recurrence_group_id: ''
              }
            });
            showToast('‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          }
        }

        await refreshBookings();
      } catch (error) {
        console.error(error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || error));
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      closeBookingModal();
    }

function viewBooking(id) {
      const booking = bookings.find(b => b.__backendId === id);
      if (!booking) return;

      selectedBooking = booking;

      const header = document.getElementById('view-modal-header');
      header.className = `p-3 sm:p-6 rounded-t-2xl ${roomColors[booking.room]?.class || 'bg-slate-600'}`;

      document.getElementById('view-title').textContent = booking.title;
      document.getElementById('view-room').textContent = booking.room;
      
      const dateObj = new Date(booking.date);
      document.getElementById('view-date').textContent = `${dateObj.getDate()} ${thaiMonths[dateObj.getMonth()]} ${dateObj.getFullYear() + 543}`;
      document.getElementById('view-time').textContent = `${booking.start_time} - ${booking.end_time}`;

      document.getElementById('view-organizer').textContent = booking.organizer_name || booking.organizer || '-';

      const deptContainer = document.getElementById('view-dept-container');
      if (booking.department) {
        deptContainer.classList.remove('hidden');
        document.getElementById('view-dept').textContent = booking.department;
      } else {
        deptContainer.classList.add('hidden');
      }

      const recurrenceContainer = document.getElementById('view-recurrence-container');
      if (booking.recurrence_type && booking.recurrence_type !== 'none') {
        recurrenceContainer.classList.remove('hidden');
        document.getElementById('view-recurrence').textContent = recurrenceLabels[booking.recurrence_type] || booking.recurrence_type;
        document.getElementById('delete-all-btn').classList.remove('hidden');
      } else {
        recurrenceContainer.classList.add('hidden');
        document.getElementById('delete-all-btn').classList.add('hidden');
      }

      const attendeesContainer = document.getElementById('view-attendees-container');
      if (booking.attendees) {
        attendeesContainer.classList.remove('hidden');
        const attendeeLines = booking.attendees.split('; ').map(a => `<div>${a}</div>`).join('');
        document.getElementById('view-attendees').innerHTML = attendeeLines;
      } else {
        attendeesContainer.classList.add('hidden');
      }

      const descContainer = document.getElementById('view-description-container');
      if (booking.description) {
        descContainer.classList.remove('hidden');
        document.getElementById('view-description').textContent = booking.description;
      } else {
        descContainer.classList.add('hidden');
      }

      hideDeleteConfirm();
      document.getElementById('view-modal').classList.remove('hidden');
      document.getElementById('view-modal').classList.add('flex');
    }

    function closeViewModal() {
      document.getElementById('view-modal').classList.add('hidden');
      document.getElementById('view-modal').classList.remove('flex');
      selectedBooking = null;
    }

    function editBooking() {
      if (!selectedBooking) return;

      isEditing = true;
      closeViewModal();
      
      document.getElementById('modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
      document.getElementById('booking-id').value = selectedBooking.__backendId;
      document.getElementById('booking-title').value = selectedBooking.title;
      document.getElementById('booking-organizer').value = selectedBooking.organizer_name || selectedBooking.organizer || '';
      document.getElementById('booking-organizer-email').value = selectedBooking.organizer_email || '';
      document.getElementById('booking-department').value = selectedBooking.department || '';
      
      document.getElementById('booking-date').value = selectedBooking.date;
      document.getElementById('booking-date-display').value = formatDateDisplay(selectedBooking.date);
      document.getElementById('booking-start').value = selectedBooking.start_time;
      document.getElementById('booking-end').value = selectedBooking.end_time;
      document.getElementById('booking-description').value = selectedBooking.description || '';
      
      // attendees (names/emails)
      attendeesList = [];
      const names = (selectedBooking.attendees_names || selectedBooking.attendees || '').split(';').map(s=>s.trim()).filter(Boolean);
      const emails = (selectedBooking.attendees_emails || '').split(';').map(s=>s.trim());
      names.forEach((name, i) => attendeesList.push({ name, email: emails[i] || '' }));
      updateAttendeesDisplay();
      
      const roomRadio = document.querySelector(`input[name="room"][value="${selectedBooking.room}"]`);
      if (roomRadio) roomRadio.checked = true;

      document.getElementById('recurrence-type').value = 'none';
      document.getElementById('recurrence-end-container').classList.add('hidden');
      const re = document.getElementById('recurrence-end'); if (re) { re.value=''; re.required=false; }
      const reDisp = document.getElementById('recurrence-end-display'); if (reDisp) reDisp.value='';

      document.getElementById('booking-modal').classList.remove('hidden');
      document.getElementById('booking-modal').classList.add('flex');
    }

    function showDeleteConfirm() {
      document.getElementById('delete-confirm').classList.remove('hidden');
      document.getElementById('delete-btn').classList.add('hidden');
    }

    function hideDeleteConfirm() {
      document.getElementById('delete-confirm').classList.add('hidden');
      document.getElementById('delete-btn').classList.remove('hidden');
    }

    async function deleteBooking(mode) {
      if (!selectedBooking) return;

      const buttons = document.querySelectorAll('#delete-options button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span>';
      });

      try {
        if (mode === 'all' && selectedBooking.recurrence_group_id) {
          await api('deleteBooking', { mode: 'group', groupId: selectedBooking.recurrence_group_id });
          showToast('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } else {
          await api('deleteBooking', { mode: 'single', id: selectedBooking.__backendId || selectedBooking.id });
          showToast('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        await refreshBookings();
        closeViewModal();
      } catch (error) {
        console.error(error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
      }

      buttons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = btn.id === 'delete-all-btn' ? '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ';
      });
      hideDeleteConfirm();
    }

function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    init();
  
</script>
</body>
</html>
