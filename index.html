<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESS Meeting Rooms</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#ffffff;
  color:#0f172a;
}
.wrap{
  max-width:1100px;
  margin:auto;
  padding:30px;
}
h1{margin:0 0 20px}

.rooms{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}
.room{
  border:2px solid #e2e8f0;
  border-radius:18px;
  padding:20px;
  cursor:pointer;
  transition:.2s;
}
.room:hover{
  border-color:#2563eb;
  transform:translateY(-3px);
}
.list{
  margin-top:15px;
  border-top:1px solid #e2e8f0;
  padding-top:10px;
}
.btn{
  padding:8px 12px;
  border:none;
  background:#2563eb;
  color:white;
  border-radius:8px;
  cursor:pointer;
}
select,input{
  width:100%;
  padding:8px;
  margin-bottom:10px;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modalBox{
  background:white;
  padding:20px;
  border-radius:14px;
  width:400px;
}
</style>
</head>
<body>

<div class="wrap">
<h1>Meeting Rooms</h1>

<div class="rooms" id="rooms"></div>
</div>

<div class="modal" id="modal">
  <div class="modalBox">
    <h3 id="modalTitle"></h3>
    <input type="date" id="date">
    <div id="bookingList"></div>
    <hr>
    <button class="btn" onclick="openBook()">จองห้อง</button>
    <button class="btn" onclick="closeModal()">ปิด</button>
  </div>
</div>

<div class="modal" id="bookModal">
  <div class="modalBox">
    <h3>จองห้อง</h3>
    <input type="date" id="bkDate">
    <select id="bkDept"></select>
    <select id="bkName"></select>
    <input id="bkEmail" disabled placeholder="email">
    <input id="bkTitle" placeholder="หัวข้อประชุม">
    <select id="bkStart"></select>
    <select id="bkEnd"></select>
    <button class="btn" onclick="save()">บันทึก</button>
    <button class="btn" onclick="closeBook()">ยกเลิก</button>
  </div>
</div>

<script>

const WEBAPP_URL = "ใส่_WEB_APP_URL";
const API_KEY = "ESS-ROOM-2026";

const rooms = ["mind","power","reality","space"];

let state = {
  room:null,
  employees:[]
};

/* ===== JSONP ===== */
function callAPI(params, callback){
  const cb = "cb"+Math.random().toString(36).substring(2);
  params.callback = cb;
  const script = document.createElement("script");
  script.src = WEBAPP_URL + "?" + new URLSearchParams(params);
  window[cb] = function(res){
    callback(res);
    delete window[cb];
    document.body.removeChild(script);
  }
  document.body.appendChild(script);
}

/* ===== INIT ===== */
function init(){
  const roomsEl = document.getElementById("rooms");
  rooms.forEach(r=>{
    const div = document.createElement("div");
    div.className="room";
    div.innerHTML=`<h3>${r}</h3><div id="list_${r}"></div>`;
    div.onclick=()=>openRoom(r);
    roomsEl.appendChild(div);
  });

  callAPI({action:"employees",apiKey:API_KEY},res=>{
    if(res.ok){
      state.employees = res.employees;
      setupDept();
    }
  });

  buildTime();
}
init();

/* ===== ROOM ===== */
function openRoom(room){
  state.room=room;
  document.getElementById("modalTitle").innerText=room;
  document.getElementById("date").valueAsDate=new Date();
  loadBookings();
  document.getElementById("modal").style.display="flex";
}
function closeModal(){
  document.getElementById("modal").style.display="none";
}
function loadBookings(){
  const date = document.getElementById("date").value;
  callAPI({action:"bookings",apiKey:API_KEY,roomKey:state.room,date},res=>{
    const list=document.getElementById("bookingList");
    list.innerHTML="";
    if(res.items.length===0){
      list.innerHTML="ไม่มีการจอง";
      return;
    }
    res.items.forEach(it=>{
      list.innerHTML+=`<div>${it.start}-${it.end} | ${it.title}</div>`;
    });
  });
}
document.getElementById("date").addEventListener("change",loadBookings);

/* ===== BOOK ===== */
function openBook(){
  document.getElementById("bkDate").value=document.getElementById("date").value;
  document.getElementById("bookModal").style.display="flex";
}
function closeBook(){
  document.getElementById("bookModal").style.display="none";
}
function setupDept(){
  const deptSel=document.getElementById("bkDept");
  const depts=[...new Set(state.employees.map(e=>e.department))];
  deptSel.innerHTML="<option>เลือกแผนก</option>";
  depts.forEach(d=>{
    deptSel.innerHTML+=`<option>${d}</option>`;
  });
}
document.getElementById("bkDept").onchange=function(){
  const dept=this.value;
  const nameSel=document.getElementById("bkName");
  nameSel.innerHTML="";
  state.employees.filter(e=>e.department===dept)
    .forEach(e=>{
      nameSel.innerHTML+=`<option value="${e.email}">${e.name}</option>`;
    });
}
document.getElementById("bkName").onchange=function(){
  document.getElementById("bkEmail").value=this.value;
}

function buildTime(){
  const startSel=document.getElementById("bkStart");
  const endSel=document.getElementById("bkEnd");
  for(let h=8;h<=17;h++){
    ["00","30"].forEach(m=>{
      const t=(h<10?"0"+h:h)+":"+m;
      startSel.innerHTML+=`<option>${t}</option>`;
      endSel.innerHTML+=`<option>${t}</option>`;
    });
  }
}

/* ===== SAVE ===== */
function save(){
  const date=document.getElementById("bkDate").value;
  const start=document.getElementById("bkStart").value;
  const end=document.getElementById("bkEnd").value;
  const title=document.getElementById("bkTitle").value;
  const email=document.getElementById("bkEmail").value;

  const startISO=date+"T"+start+":00+07:00";
  const endISO=date+"T"+end+":00+07:00";

  callAPI({
    action:"createmeeting",
    apiKey:API_KEY,
    roomKey:state.room,
    title,
    start:startISO,
    end:endISO,
    attendees:email,
    bookerEmail:email
  },res=>{
    if(res.ok){
      alert("จองสำเร็จ");
      closeBook();
      loadBookings();
    }else{
      alert("ผิดพลาด: "+res.error);
    }
  });
}

</script>
</body>
</html>
