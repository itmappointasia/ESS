<!doctype html>
<html>
<head><meta charset="utf-8"><title>Ping Test</title></head>
<body>
  <button id="btn">Ping Backend</button>
  <pre id="log" style="white-space:pre-wrap"></pre>

<script>
const WEBAPP_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhdDAgb1K26CN43IazISEEF_3qhCbtsLZI48hw6TKNSDh_hnvwmNmDsWPyLMHJ3XyWy6HPruCs_Nv3jv9QFZQI2ndu-IiQmkyC2y4XM0QQJNVT9wy3C6mbYAthWE8g1Bc33WtYmO1iO2QtfGeOXEliNP93kLzfoNsdp0CAeG-IrzBguI2Mc-DXmKTUKcaiUgIrwWdp0PrbS0zmvcPG_a9Eltbx_yjNNEHrX3yKTVMWEfgmVaNt2ZGiTkeY6hCWGEd8BGJc76p6fCiARhtuOIeUY7fPllWVCwjANkdjT&lib=MWM25P39TFB-zj1mZ6JfwBBnAqBPosTq4"; // /exec หรือ echo
const API_KEY = "ESS-ROOM-2026";

const log = (m)=> document.getElementById('log').textContent += m + "\n";

document.getElementById("btn").onclick = () => {
  const cb = "cb_" + Math.random().toString(36).slice(2);

  // กัน “เงียบ”: ถ้า 6 วิไม่กลับมาให้ฟ้อง
  const t = setTimeout(()=>log("TIMEOUT: ไม่มี callback กลับมา (มักเกิดจาก URL ผิด/JSONP ไม่ถูก)"), 6000);

  window[cb] = (res) => {
    clearTimeout(t);
    log("CALLBACK HIT: " + JSON.stringify(res));
    alert("PING OK");
    delete window[cb];
  };

  const s = document.createElement("script");
  s.onerror = () => {
    clearTimeout(t);
    log("SCRIPT ERROR: โหลดสคริปต์ไม่สำเร็จ (มักเป็น 404 หรือ permission)");
  };

  const url = `${WEBAPP_URL}?action=ping&apiKey=${encodeURIComponent(API_KEY)}&callback=${cb}&_=${Date.now()}`;
  log("REQUEST: " + url);
  s.src = url;
  document.body.appendChild(s);
};
</script>
</body>
</html>
