<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Meeting Room Booking</title>

  <style>
    :root{
      --bg:#eaf7f6;
      --card:#ffffff;
      --ink:#0b2b2a;
      --muted:#5b7b7a;
      --line:rgba(11,43,42,.10);

      --brand:#0f8f86;
      --brand2:#0aa39a;

      --ok:#1fbf72;
      --ok-bg:#d8f7e8;

      --bad:#e85a5a;
      --bad-bg:#fde0e0;

      --shadow: 0 16px 45px rgba(10, 30, 30, .10);
      --r:18px;

      --max:1180px;

      --chip:#eef8f7;
      --chip-line:#cfe9e6;
      --focus:rgba(15,143,134,.16);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:var(--bg);
      color:var(--ink);
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:24px 16px 40px;
    }

    /* Header */
    .hero{
      text-align:center;
      padding:22px 12px 16px;
    }
    .hero h1{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      color:#0c6f68;
      font-size: clamp(28px, 3vw, 44px);
    }
    .hero .sub{
      margin-top:6px;
      color:#2a7f79;
      font-weight:700;
      font-size: clamp(14px, 1.4vw, 18px);
    }

    /* Tabs */
    .tabs{
      margin:14px auto 18px;
      display:flex;
      justify-content:center;
      gap:28px;
      border-bottom: 1px solid rgba(11,43,42,.12);
      padding-bottom:10px;
    }
    .tab{
      appearance:none;
      border:0;
      background:transparent;
      color:rgba(11,43,42,.70);
      font-weight:800;
      font-size:16px;
      padding:10px 10px 12px;
      cursor:pointer;
      position:relative;
    }
    .tab.active{
      color:#0b6f69;
    }
    .tab.active::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-11px;
      height:3px;
      border-radius:99px;
      background:var(--brand);
    }

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .sectionTitle{
      margin:0 0 12px;
      font-weight:900;
      color:#0b6f69;
      font-size: 20px;
    }

    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:end;
    }
    .field{
      min-width: 240px;
      flex:1;
    }
    .label{
      display:block;
      font-weight:800;
      color:#356a66;
      font-size:14px;
      margin:0 0 8px;
    }
    .input, .select{
      width:100%;
      height:46px;
      border-radius:12px;
      border:1px solid rgba(11,43,42,.14);
      background:#fff;
      padding:0 12px;
      outline:none;
      font-weight:700;
      color:#0b2b2a;
    }
    .input:focus, .select:focus{
      box-shadow: 0 0 0 6px var(--focus);
      border-color: rgba(15,143,134,.45);
    }
    .btn{
      height:46px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid rgba(11,43,42,.12);
      background:var(--brand);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(15,143,134,.18);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btn.secondary{
      background:#e7f4f2;
      color:#0b6f69;
      border-color:#cfe9e6;
      box-shadow:none;
    }

    /* Booking page layout */
    .grid2{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:16px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns:1fr; }
      .field{ min-width: 100%; }
    }

    /* Calendar */
    .cal{
      border:1px solid rgba(11,43,42,.10);
      border-radius:16px;
      padding:14px;
      background:linear-gradient(180deg, rgba(15,143,134,.06), rgba(15,143,134,.02));
    }
    .calHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .calTitle{
      font-weight:900;
      color:#0b6f69;
      font-size:18px;
    }
    .calNav{
      display:flex;
      gap:8px;
    }
    .iconBtn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid rgba(11,43,42,.12);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color:#0b6f69;
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin:8px 0 10px;
      color:rgba(11,43,42,.50);
      font-weight:900;
      font-size:12px;
      text-align:center;
    }
    .days{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .day{
      height:44px;
      border-radius:14px;
      border:1px solid transparent;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color:#0b2b2a;
    }
    .day.muted{
      opacity:.35;
      cursor:default;
    }
    .day.today{
      border-color: rgba(15,143,134,.25);
    }
    .day.sel{
      background: var(--brand);
      color:#fff;
      box-shadow: 0 10px 24px rgba(15,143,134,.20);
    }

    /* Rooms + slots */
    .roomsWrap{
      border:1px solid rgba(11,43,42,.10);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .roomsHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .roomsHead h3{
      margin:0;
      font-size:16px;
      color:#0b6f69;
      font-weight:900;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      background:var(--chip);
      border:1px solid var(--chip-line);
      color:#0b6f69;
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }

    .roomsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .roomsGrid{ grid-template-columns:1fr; }
    }
    .roomCard{
      border:1px solid rgba(11,43,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .roomName{
      font-weight:1000;
      color:#0b6f69;
      font-size:18px;
      margin:0;
    }
    .roomMeta{
      margin-top:4px;
      color:rgba(11,43,42,.55);
      font-weight:800;
      font-size:13px;
    }
    .slots{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .slot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(11,43,42,.10);
      background:#f6fbfa;
      cursor:pointer;
    }
    .slot:hover{ border-color: rgba(15,143,134,.22); }
    .slotTime{
      font-weight:1000;
      color:#0b2b2a;
    }
    .slotSub{
      font-weight:800;
      color:rgba(11,43,42,.55);
      font-size:12px;
      margin-top:2px;
    }
    .slot.bad{
      background: var(--bad-bg);
      border-color: rgba(232,90,90,.35);
      cursor:default;
    }
    .slot.ok{
      background: var(--ok-bg);
      border-color: rgba(31,191,114,.35);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background:var(--ok);
      box-shadow: 0 0 0 6px rgba(31,191,114,.12);
    }
    .dot.bad{ background:var(--bad); box-shadow: 0 0 0 6px rgba(232,90,90,.12); }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.38);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(880px, 100%);
      border-radius:20px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 25px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(90deg, rgba(15,143,134,.12), rgba(15,143,134,.04));
      border-bottom:1px solid rgba(11,43,42,.10);
    }
    .modalHead .ttl{
      font-weight:1000;
      color:#0b6f69;
    }
    .close{
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(11,43,42,.12);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      color:#0b6f69;
    }
    .modalBody{ padding:16px; }
    .hint{
      margin:0 0 12px;
      color:rgba(11,43,42,.65);
      font-weight:800;
      font-size:13px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(11,43,42,.12);
      background:#fff;
      font-weight:900;
      color:#0b2b2a;
      font-size:12px;
    }
    .chip button{
      border:0;
      background:transparent;
      cursor:pointer;
      font-weight:1000;
      color:#0b6f69;
    }

    .okBox{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(31,191,114,.30);
      background: rgba(31,191,114,.10);
      padding:14px;
    }
    .okBox .big{
      font-weight:1000;
      color:#0f7a4a;
      margin:0 0 6px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* Table (Bookings list) */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(11,43,42,.10);
      background:#fff;
    }
    thead th{
      text-align:left;
      padding:12px 12px;
      background: rgba(15,143,134,.06);
      color:#0b6f69;
      font-weight:1000;
      font-size:13px;
      border-bottom:1px solid rgba(11,43,42,.10);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(11,43,42,.08);
      font-weight:800;
      color:#0b2b2a;
      vertical-align:top;
    }
    tbody tr:last-child td{ border-bottom:0; }
    .dangerBtn{
      height:36px;
      padding:0 12px;
      border-radius:10px;
      border:0;
      background: var(--bad);
      color:#fff;
      font-weight:1000;
      cursor:not-allowed;
      opacity:.65;
    }
    .small{
      font-size:12px;
      color:rgba(11,43,42,.55);
      font-weight:800;
      margin-top:4px;
    }

    /* Stats */
    .statsRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .statsRow{ grid-template-columns:1fr; }
    }
    .statCard{
      border-radius:16px;
      border:1px solid rgba(11,43,42,.10);
      background:#fff;
      padding:14px;
    }
    .statLabel{
      color:rgba(11,43,42,.55);
      font-weight:900;
      font-size:13px;
      margin:0 0 8px;
    }
    .statValue{
      font-weight:1000;
      font-size:34px;
      margin:0;
    }
    .chartWrap{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(11,43,42,.10);
      background:#fff;
      padding:14px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#0b2b2a;
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:80;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    /* Loader */
    .busy{
      display:inline-flex; align-items:center; gap:10px;
      font-weight:900; color:#0b6f69;
    }
    .spin{
      width:16px; height:16px; border-radius:99px;
      border:3px solid rgba(15,143,134,.25);
      border-top-color: rgba(15,143,134,.90);
      animation: r 0.8s linear infinite;
    }
    @keyframes r{ to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>Smart Meeting Room Booking</h1>
      <div class="sub">ระบบจองห้องประชุมอัจฉริยะ</div>
    </div>

    <div class="tabs" role="tablist" aria-label="tabs">
      <button class="tab active" data-tab="book" role="tab">จองห้องประชุม</button>
      <button class="tab" data-tab="list" role="tab">รายการจองของฉัน</button>
      <button class="tab" data-tab="stats" role="tab">สถิติการใช้งาน</button>
    </div>

    <!-- BOOK TAB -->
    <section id="tab-book">
      <div class="card">
        <h2 class="sectionTitle">1. เลือกวันที่ต้องการจอง</h2>

        <div class="grid2">
          <div class="cal" id="calendar"></div>

          <div class="roomsWrap">
            <div class="roomsHead">
              <h3 id="dayTitle">รายการจองห้องประชุมวันนี้</h3>
              <span class="pill" id="serverPill">เชื่อมต่อระบบ…</span>
            </div>

            <div class="row" style="margin-bottom:12px">
              <div class="field">
                <span class="label">อีเมลผู้จอง (จำเป็น)</span>
                <input class="input" id="bookerEmail" placeholder="เช่น user@company.com" autocomplete="email" />
              </div>
              <div class="field">
                <span class="label">ค้นหาพนักงาน/ผู้ร่วมประชุม</span>
                <input class="input" id="empSearch" placeholder="พิมพ์ชื่อหรืออีเมล แล้วกด Enter" />
                <div class="chips" id="chips"></div>
              </div>
            </div>

            <div class="row" style="margin-bottom:12px">
              <div class="field">
                <span class="label">เวลาเริ่มต้น</span>
                <select class="select" id="startTime"></select>
              </div>
              <div class="field">
                <span class="label">เวลาสิ้นสุด (จองได้ไม่เกิน 4 ชั่วโมง)</span>
                <select class="select" id="endTime"></select>
              </div>
              <div>
                <button class="btn secondary" id="refreshBtn">รีเฟรชสถานะห้อง</button>
              </div>
            </div>

            <div class="roomsGrid" id="roomsGrid"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- LIST TAB -->
    <section id="tab-list" style="display:none">
      <div class="card">
        <h2 class="sectionTitle">รายการจองของฉัน</h2>

        <div class="row" style="margin-bottom:12px">
          <div class="field">
            <span class="label">กรองตามห้อง</span>
            <select class="select" id="filterRoom">
              <option value="">ทุกห้อง</option>
              <option value="mind">Mind</option>
              <option value="reality">Reality</option>
              <option value="power">Power</option>
              <option value="space">Space</option>
            </select>
          </div>
          <div class="field">
            <span class="label">กรองตามวันที่ (YYYY-MM-DD)</span>
            <input class="input" id="filterDate" placeholder="เช่น 2026-04-25" />
            <div class="small">หมายเหตุ: Backend ของคุณมี endpoint bookings แบบราย “ห้อง+วัน” จึงใช้วิธีกรองตามวัน/ห้อง แล้วเลือกเฉพาะรายการที่ชื่อผู้จองตรง</div>
          </div>
          <div class="field">
            <span class="label">ชื่อผู้จอง (ต้องตรงกับที่บันทึกในชีต)</span>
            <input class="input" id="filterBooker" placeholder="เช่น อาจารย์เบนนี้" />
          </div>
          <div>
            <button class="btn" id="loadListBtn">โหลดรายการ</button>
          </div>
        </div>

        <div id="listBusy" class="busy" style="display:none;margin:10px 0;">
          <span class="spin"></span> กำลังโหลด…
        </div>

        <div id="listWrap"></div>
      </div>
    </section>

    <!-- STATS TAB -->
    <section id="tab-stats" style="display:none">
      <div class="card">
        <h2 class="sectionTitle">สถิติการใช้งานห้องประชุม</h2>

        <div class="row" style="margin-bottom:12px">
          <div class="field">
            <span class="label">ช่วงเวลา</span>
            <select class="select" id="rangeDays">
              <option value="7">7 วันล่าสุด</option>
              <option value="14">14 วันล่าสุด</option>
              <option value="30">30 วันล่าสุด</option>
            </select>
          </div>
          <div class="field">
            <span class="label">ประเภทสถิติ</span>
            <select class="select" id="statType">
              <option value="byHour">การใช้งานตามช่วงเวลา</option>
              <option value="byRoom">ห้องที่ถูกใช้งานมากที่สุด</option>
            </select>
          </div>
          <div>
            <button class="btn" id="updateStatsBtn">อัปเดตสถิติ</button>
          </div>
        </div>

        <div class="statsRow">
          <div class="statCard">
            <p class="statLabel">จำนวนการจองทั้งหมด</p>
            <p class="statValue" id="statTotal">-</p>
          </div>
          <div class="statCard">
            <p class="statLabel">ห้องที่ถูกใช้งานมากที่สุด</p>
            <p class="statValue" id="statTopRoom">-</p>
          </div>
          <div class="statCard">
            <p class="statLabel">ช่วงเวลาที่ใช้งานมากที่สุด</p>
            <p class="statValue" id="statTopHour">-</p>
          </div>
        </div>

        <div class="chartWrap">
          <div style="font-weight:1000;color:#0b6f69;margin:0 0 10px;">กราฟการใช้งาน</div>
          <canvas id="chart" height="120"></canvas>
        </div>

        <div id="statsBusy" class="busy" style="display:none;margin:10px 0;">
          <span class="spin"></span> กำลังคำนวณสถิติ…
        </div>
      </div>
    </section>
  </div>

  <!-- Modal (booking form) -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="ttl" id="modalTitle">จองห้องประชุม</div>
        <button class="close" id="closeModal">✕</button>
      </div>
      <div class="modalBody">
        <p class="hint" id="modalHint">กรอกข้อมูลการประชุม แล้วกด “ยืนยันการจอง”</p>

        <div class="row">
          <div class="field">
            <span class="label">หัวข้อการประชุม</span>
            <input class="input" id="meetTitle" placeholder="เช่น ประชุมพัฒนาระบบ" />
          </div>
          <div class="field">
            <span class="label">รายละเอียดการประชุม</span>
            <input class="input" id="meetDesc" placeholder="เช่น ติดตามงาน Sprint / Requirements" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <span class="label">วัน-เวลา</span>
            <input class="input" id="meetWhen" disabled />
          </div>
          <div class="field">
            <span class="label">ห้อง</span>
            <input class="input" id="meetRoom" disabled />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <span class="label">ผู้เข้าร่วม (อีเมลคั่นด้วย , )</span>
            <input class="input" id="meetAtt" placeholder="เช่น a@x.com, b@y.com" />
            <div class="small">ระบบจะส่งอีเมลเชิญผ่าน Calendar API ที่ backend ของคุณ</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn secondary" id="cancelBtn">ยกเลิก</button>
          <button class="btn" id="confirmBtn">ยืนยันการจอง</button>
        </div>

        <div id="modalBusy" class="busy" style="display:none;margin-top:12px;">
          <span class="spin"></span> กำลังสร้างรายการจอง…
        </div>

        <div class="okBox" id="successBox" style="display:none;">
          <p class="big">✅ จองห้องประชุมสำเร็จ</p>
          <div id="successText" style="font-weight:900;color:#0b2b2a;"></div>
          <div class="small" id="successLink"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ข้อความแจ้งเตือน</div>

  <script>
    /************************************************************
     * CONFIG (แก้ตรงนี้)
     ************************************************************/
    const WEBAPP_URL = "PUT_YOUR_SCRIPT_WEBAPP_URL_HERE"; // เช่น https://script.google.com/macros/s/XXXX/exec
    const API_KEY = "ESS-ROOM-2026";

    /************************************************************
     * ROOM MAP (เหมือน backend: Mind/Reality/Power/Space)
     ************************************************************/
    const ROOMS = [
      { key:"mind",    name:"ห้อง Mind",    capacity: 20 },
      { key:"reality", name:"ห้อง Reality", capacity: 20 },
      { key:"power",   name:"ห้อง Power",   capacity: 10 },
      { key:"space",   name:"ห้อง Space",   capacity: 6  },
    ];

    const TZ_OFFSET = "+07:00"; // Asia/Bangkok (สำหรับสร้าง ISO ส่งให้ backend)

    /************************************************************
     * STATE
     ************************************************************/
    const state = {
      serverOk: false,
      serverTz: "Asia/Bangkok",
      selected: ymdToday(),
      calYear: new Date().getFullYear(),
      calMonth: new Date().getMonth(), // 0-11
      employees: [],
      chips: [], // selected attendee emails
      bookingsByRoom: new Map(), // roomKey -> items[]
    };

    /************************************************************
     * JSONP Helper
     ************************************************************/
    function jsonp(params){
      return new Promise((resolve, reject) => {
        if (!WEBAPP_URL || WEBAPP_URL.includes("PUT_YOUR")) {
          reject(new Error("กรุณาตั้งค่า WEBAPP_URL ก่อนใช้งาน"));
          return;
        }
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const url = new URL(WEBAPP_URL);
        url.searchParams.set("callback", cb);
        url.searchParams.set("apiKey", API_KEY);
        Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));

        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("Timeout ติดต่อ backend ไม่สำเร็จ"));
        }, 15000);

        window[cb] = (data) => {
          cleanup();
          resolve(data);
        };

        function cleanup(){
          clearTimeout(timer);
          delete window[cb];
          script.remove();
        }

        script.onerror = () => {
          cleanup();
          reject(new Error("โหลด JSONP script ไม่สำเร็จ"));
        };

        script.src = url.toString();
        document.body.appendChild(script);
      });
    }

    /************************************************************
     * Utils
     ************************************************************/
    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymdFromDate(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function ymdToday(){ return ymdFromDate(new Date()); }

    function thaiDateLong(ymd){
      const [y,m,d] = ymd.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      const opt = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
      // แสดงเป็น พ.ศ. ตามภาพตัวอย่าง
      return dt.toLocaleDateString("th-TH-u-ca-buddhist", opt);
    }

    function hmToMin(hm){
      const m = String(hm).match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return 999999;
      return Number(m[1])*60 + Number(m[2]);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function buildIso(ymd, hm){
      // ส่งเป็น 2026-04-25T10:00:00+07:00
      return `${ymd}T${hm}:00${TZ_OFFSET}`;
    }

    function addMinutes(hm, mins){
      const t = hmToMin(hm) + mins;
      const h = Math.floor(t/60);
      const m = t%60;
      return pad2(h)+":"+pad2(m);
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2600);
    }

    /************************************************************
     * Times (08:00 - 17:30 step 30m; แต่ slot แสดงเป็นชั่วโมง)
     ************************************************************/
    const TIME_START = "08:00";
    const TIME_END   = "17:30";
    const STEP_MIN   = 30;
    function buildTimeOptions(){
      const startSel = document.getElementById("startTime");
      const endSel = document.getElementById("endTime");
      startSel.innerHTML = "";
      endSel.innerHTML = "";

      let t = TIME_START;
      const times = [];
      while (hmToMin(t) <= hmToMin(TIME_END)){
        times.push(t);
        t = addMinutes(t, STEP_MIN);
      }
      for (const x of times){
        const o = document.createElement("option");
        o.value = x; o.textContent = x;
        startSel.appendChild(o);
      }
      // default
      startSel.value = "10:00";

      // end options will be refreshed by validateTimeRange()
      validateTimeRange();
    }

    function validateTimeRange(){
      const startSel = document.getElementById("startTime");
      const endSel = document.getElementById("endTime");
      const s = startSel.value;

      endSel.innerHTML = "";
      // max 4 hours
      const sMin = hmToMin(s);
      const maxEnd = sMin + 240;
      let t = addMinutes(s, STEP_MIN);
      while (hmToMin(t) <= hmToMin(TIME_END) && hmToMin(t) <= maxEnd){
        const o = document.createElement("option");
        o.value = t; o.textContent = t;
        endSel.appendChild(o);
        t = addMinutes(t, STEP_MIN);
      }

      // default end = start + 60 (ถ้าได้)
      const want = addMinutes(s, 60);
      const exists = [...endSel.options].some(o => o.value === want);
      endSel.value = exists ? want : (endSel.options[0]?.value || want);
    }

    /************************************************************
     * Calendar UI
     ************************************************************/
    function renderCalendar(){
      const cal = document.getElementById("calendar");
      cal.innerHTML = "";

      const head = document.createElement("div");
      head.className = "calHead";

      const title = document.createElement("div");
      title.className = "calTitle";
      const monthName = new Date(state.calYear, state.calMonth, 1)
        .toLocaleDateString("th-TH-u-ca-buddhist", { month:"long", year:"numeric" });
      title.textContent = monthName;

      const nav = document.createElement("div");
      nav.className = "calNav";

      const prev = document.createElement("button");
      prev.className = "iconBtn";
      prev.textContent = "‹";
      prev.onclick = () => {
        state.calMonth--;
        if (state.calMonth < 0){ state.calMonth=11; state.calYear--; }
        renderCalendar();
      };

      const next = document.createElement("button");
      next.className = "iconBtn";
      next.textContent = "›";
      next.onclick = () => {
        state.calMonth++;
        if (state.calMonth > 11){ state.calMonth=0; state.calYear++; }
        renderCalendar();
      };

      nav.append(prev, next);
      head.append(title, nav);

      const dow = document.createElement("div");
      dow.className = "dow";
      ["อา","จ","อ","พ","พฤ","ศ","ส"].forEach(x=>{
        const d = document.createElement("div");
        d.textContent = x;
        dow.appendChild(d);
      });

      const days = document.createElement("div");
      days.className = "days";

      const first = new Date(state.calYear, state.calMonth, 1);
      const startDow = first.getDay(); // 0=Sun
      const daysInMonth = new Date(state.calYear, state.calMonth+1, 0).getDate();

      // previous month trailing
      const prevMonthDays = new Date(state.calYear, state.calMonth, 0).getDate();
      for (let i=0;i<startDow;i++){
        const dayNum = prevMonthDays - startDow + i + 1;
        const b = document.createElement("button");
        b.className = "day muted";
        b.textContent = dayNum;
        b.disabled = true;
        days.appendChild(b);
      }

      // current month
      for (let d=1; d<=daysInMonth; d++){
        const dt = new Date(state.calYear, state.calMonth, d);
        const ymd = ymdFromDate(dt);

        const b = document.createElement("button");
        b.className = "day";
        b.textContent = d;

        const today = ymdToday();
        if (ymd === today) b.classList.add("today");
        if (ymd === state.selected) b.classList.add("sel");

        b.onclick = () => {
          state.selected = ymd;
          renderCalendar();
          updateDayTitle();
          loadBookingsForSelected();
        };

        days.appendChild(b);
      }

      // next month leading to fill 6 rows nicely (optional)
      const totalCells = startDow + daysInMonth;
      const add = (totalCells % 7 === 0) ? 0 : (7 - (totalCells % 7));
      for (let i=1; i<=add; i++){
        const b = document.createElement("button");
        b.className = "day muted";
        b.textContent = i;
        b.disabled = true;
        days.appendChild(b);
      }

      cal.append(head, dow, days);
    }

    function updateDayTitle(){
      const el = document.getElementById("dayTitle");
      el.textContent = `รายการจองห้องประชุมวันที่ ${thaiDateLong(state.selected)}`;
    }

    /************************************************************
     * Data loading
     ************************************************************/
    async function ping(){
      try{
        const res = await jsonp({ action:"ping" });
        if (!res?.ok) throw new Error(res?.error || "ping failed");
        state.serverOk = true;
        state.serverTz = res.tz || "Asia/Bangkok";
        document.getElementById("serverPill").textContent = `เชื่อมต่อแล้ว (${state.serverTz})`;
      }catch(err){
        state.serverOk = false;
        document.getElementById("serverPill").textContent = "เชื่อมต่อไม่สำเร็จ";
        toast(String(err.message || err));
      }
    }

    async function loadEmployees(){
      try{
        const res = await jsonp({ action:"employees" });
        if (!res?.ok) throw new Error(res?.error || "employees failed");
        state.employees = res.employees || [];
      }catch(err){
        // ไม่บล็อกการจอง แต่แจ้งเตือน
        toast("โหลดรายชื่อพนักงานไม่สำเร็จ (ยังจองได้)");
      }
    }

    async function loadBookings(roomKey, ymd){
      const res = await jsonp({ action:"bookings", roomKey, date: ymd });
      if (!res?.ok) throw new Error(res?.error || "bookings failed");
      return res.items || [];
    }

    async function loadBookingsForSelected(){
      document.getElementById("roomsGrid").innerHTML =
        `<div class="busy"><span class="spin"></span> กำลังโหลดสถานะห้อง…</div>`;

      const ymd = state.selected;

      const tasks = ROOMS.map(async r=>{
        try{
          const items = await loadBookings(r.key, ymd);
          state.bookingsByRoom.set(r.key, items);
        }catch(err){
          state.bookingsByRoom.set(r.key, []);
        }
      });

      await Promise.all(tasks);
      renderRooms();
    }

    /************************************************************
     * Build hourly slots like screenshot (08:00-17:00, 1h)
     ************************************************************/
    function buildHourlySlots(){
      const out = [];
      let t = "08:00";
      while (hmToMin(t) < hmToMin("17:00")){
        out.push({ start:t, end:addMinutes(t, 60) });
        t = addMinutes(t, 60);
      }
      return out;
    }

    function isPastSlot(ymd, startHm){
      const now = new Date();
      const today = ymdToday();
      if (ymd !== today) return false;
      // วันนี้: slot ที่ start <= now ถือว่า past (ให้สอดคล้อง backend ที่ไม่ให้จองเวลาย้อน)
      const nowMin = now.getHours()*60 + now.getMinutes();
      return hmToMin(startHm) <= nowMin;
    }

    function slotBooked(roomItems, slot){
      // ถ้ารายการทับช่วงเวลา: (start < slot.end && end > slot.start)
      const a0 = hmToMin(slot.start), a1 = hmToMin(slot.end);
      for (const it of roomItems){
        const b0 = hmToMin(it.start), b1 = hmToMin(it.end);
        if (b0 < a1 && b1 > a0) return it;
      }
      return null;
    }

    function renderRooms(){
      const grid = document.getElementById("roomsGrid");
      grid.innerHTML = "";

      const slots = buildHourlySlots();

      for (const room of ROOMS){
        const items = state.bookingsByRoom.get(room.key) || [];

        const card = document.createElement("div");
        card.className = "roomCard";

        const h = document.createElement("h4");
        h.className = "roomName";
        h.textContent = room.name;

        const meta = document.createElement("div");
        meta.className = "roomMeta";
        meta.textContent = `จำนวนที่นั่ง: ${room.capacity} คน`;

        const list = document.createElement("div");
        list.className = "slots";

        for (const s of slots){
          const booked = slotBooked(items, s);
          const past = isPastSlot(state.selected, s.start);

          const row = document.createElement("div");
          row.className = "slot";
          const time = document.createElement("div");
          time.innerHTML = `<div class="slotTime">${s.start} - ${s.end}</div>` +
                           (booked ? `<div class="slotSub">โดย: ${escapeHtml(booked.booker || "-")}</div>` : "");

          const tag = document.createElement("div");
          tag.className = "tag";

          if (booked){
            row.classList.add("bad");
            tag.innerHTML = `<span class="dot bad"></span> จองแล้ว`;
          } else if (past){
            row.classList.add("bad");
            tag.innerHTML = `<span class="dot bad"></span> เวลาผ่านแล้ว`;
          } else {
            row.classList.add("ok");
            tag.innerHTML = `<span class="dot"></span> ว่าง`;
            row.onclick = () => openBookingModal(room, s);
          }

          row.append(time, tag);
          list.appendChild(row);
        }

        card.append(h, meta, list);
        grid.appendChild(card);
      }
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /************************************************************
     * Attendees chips (from employees)
     ************************************************************/
    function renderChips(){
      const box = document.getElementById("chips");
      box.innerHTML = "";
      for (const email of state.chips){
        const c = document.createElement("span");
        c.className = "chip";
        c.innerHTML = `${escapeHtml(email)} <button title="ลบ">✕</button>`;
        c.querySelector("button").onclick = () => {
          state.chips = state.chips.filter(x => x !== email);
          renderChips();
        };
        box.appendChild(c);
      }
    }

    function addChip(email){
      email = String(email||"").trim().toLowerCase();
      if (!email) return;
      if (!email.includes("@")) { toast("กรุณาใส่อีเมลที่ถูกต้อง"); return; }
      if (!state.chips.includes(email)){
        state.chips.push(email);
        renderChips();
      }
    }

    /************************************************************
     * Modal booking
     ************************************************************/
    const modal = {
      roomKey:null,
      roomName:null,
      start:null,
      end:null,
      ymd:null
    };

    function openBookingModal(room, slot){
      // ใช้เวลาตาม dropdown ถ้าผู้ใช้กำหนดช่วงเวลาเอง
      const startSel = document.getElementById("startTime").value;
      const endSel = document.getElementById("endTime").value;

      // ถ้า dropdown ช่วงเวลาทับ slot ที่คลิก ให้ยึด dropdown (เหมือน flow ภาพ 2)
      // แต่ถ้าผู้ใช้ยังไม่แตะ dropdown ให้ “เด้ง” ตาม slot ที่คลิก
      const useStart = startSel || slot.start;
      const useEnd   = endSel || slot.end;

      // validate (ไม่เกิน 4 ชม.)
      const dur = hmToMin(useEnd) - hmToMin(useStart);
      if (dur <= 0){ toast("เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม"); return; }
      if (dur > 240){ toast("จองได้ไม่เกิน 4 ชั่วโมง"); return; }
      if (isPastSlot(state.selected, useStart)){ toast("เวลานี้ผ่านแล้ว (วันนี้)"); return; }

      modal.roomKey = room.key;
      modal.roomName = room.name;
      modal.start = useStart;
      modal.end = useEnd;
      modal.ymd = state.selected;

      document.getElementById("modalTitle").textContent = "จองห้องประชุม";
      document.getElementById("meetRoom").value = `${room.name}`;
      document.getElementById("meetWhen").value = `${thaiDateLong(modal.ymd)} เวลา ${modal.start} - ${modal.end} น.`;
      document.getElementById("meetTitle").value = "";
      document.getElementById("meetDesc").value = "";

      // attendees from chips (auto fill)
      document.getElementById("meetAtt").value = state.chips.join(", ");

      document.getElementById("successBox").style.display = "none";
      document.getElementById("modalBusy").style.display = "none";
      document.getElementById("confirmBtn").disabled = false;

      showModal(true);
    }

    function showModal(show){
      const bd = document.getElementById("backdrop");
      bd.classList.toggle("show", !!show);
      bd.setAttribute("aria-hidden", show ? "false" : "true");
    }

    async function confirmBooking(){
      const bookerEmail = document.getElementById("bookerEmail").value.trim().toLowerCase();
      if (!bookerEmail || !bookerEmail.includes("@")){
        toast("กรุณากรอกอีเมลผู้จองให้ถูกต้อง");
        return;
      }

      const title = document.getElementById("meetTitle").value.trim() || "Meeting";
      const description = document.getElementById("meetDesc").value.trim();
      const att = document.getElementById("meetAtt").value.trim();

      const startIso = buildIso(modal.ymd, modal.start);
      const endIso   = buildIso(modal.ymd, modal.end);

      document.getElementById("modalBusy").style.display = "flex";
      document.getElementById("confirmBtn").disabled = true;

      try{
        const res = await jsonp({
          action:"createmeeting",
          roomKey: modal.roomKey,
          title,
          description,
          attendees: att,
          bookerEmail,
          start: startIso,
          end: endIso
        });

        if (!res?.ok){
          throw new Error(res?.error || res?.message || "จองไม่สำเร็จ");
        }

        const ok = document.getElementById("successBox");
        ok.style.display = "block";
        document.getElementById("successText").innerHTML =
          `<b>${escapeHtml(modal.roomName)}</b><br>`+
          `${escapeHtml(thaiDateLong(modal.ymd))} เวลา ${escapeHtml(modal.start)} - ${escapeHtml(modal.end)} น.<br>`+
          `ผู้จอง: ${escapeHtml(res.employeeLookup?.name || bookerEmail)}`;

        const link = res.calendar?.htmlLink ? res.calendar.htmlLink : "";
        document.getElementById("successLink").innerHTML =
          link ? `เปิดเหตุการณ์ในปฏิทิน: <a href="${escapeHtml(link)}" target="_blank" rel="noopener">คลิกที่นี่</a>` :
                 `สร้างเหตุการณ์ปฏิทินแล้ว`;

        toast("จองสำเร็จ ✅");
        await loadBookingsForSelected(); // refresh

      }catch(err){
        toast(String(err.message || err));
      }finally{
        document.getElementById("modalBusy").style.display = "none";
        document.getElementById("confirmBtn").disabled = false;
      }
    }

    /************************************************************
     * List tab (ไม่สามารถ “ยกเลิก” ได้ เพราะ backend ไม่มี endpoint cancel)
     * จึงโชว์ปุ่มยกเลิกแบบ disabled ตามภาพ
     ************************************************************/
    async function loadList(){
      const wrap = document.getElementById("listWrap");
      const busy = document.getElementById("listBusy");
      wrap.innerHTML = "";
      busy.style.display = "flex";

      const roomKey = document.getElementById("filterRoom").value.trim();
      const ymd = document.getElementById("filterDate").value.trim();
      const booker = document.getElementById("filterBooker").value.trim();

      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(ymd)){
        busy.style.display = "none";
        toast("กรุณากรอกวันที่เป็น YYYY-MM-DD");
        return;
      }
      if (!booker){
        busy.style.display = "none";
        toast("กรุณากรอกชื่อผู้จอง (ให้ตรงกับข้อมูลในชีต)");
        return;
      }

      try{
        const keys = roomKey ? [roomKey] : ROOMS.map(r=>r.key);
        const all = [];

        for (const k of keys){
          const items = await loadBookings(k, ymd);
          const roomName = ROOMS.find(r=>r.key===k)?.name || k;
          for (const it of items){
            if (String(it.booker||"").includes(booker)){
              all.push({
                room: roomName,
                date: ymd,
                time: `${it.start} - ${it.end}`,
                booker: it.booker || "",
                title: it.title || "",
              });
            }
          }
        }

        if (all.length === 0){
          wrap.innerHTML = `<div class="small">ไม่พบรายการ (ลองเปลี่ยนวัน/ห้อง/ชื่อผู้จอง)</div>`;
          return;
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>ห้อง</th>
              <th>วันที่</th>
              <th>เวลา</th>
              <th>ชื่อผู้จอง</th>
              <th>วัตถุประสงค์</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tb = table.querySelector("tbody");
        for (const r of all){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(r.room)}</td>
            <td>${escapeHtml(thaiDateLong(r.date))}</td>
            <td>${escapeHtml(r.time)}</td>
            <td>${escapeHtml(r.booker)}</td>
            <td>${escapeHtml(r.title)}</td>
            <td><button class="dangerBtn" title="Backend ยังไม่มี endpoint ยกเลิกการจอง">ยกเลิกการจอง</button></td>
          `;
          tb.appendChild(tr);
        }
        wrap.appendChild(table);

      }catch(err){
        toast(String(err.message || err));
      }finally{
        busy.style.display = "none";
      }
    }

    /************************************************************
     * Stats tab (คำนวณจากการดึง bookings รายวัน/รายห้อง)
     ************************************************************/
    async function updateStats(){
      const busy = document.getElementById("statsBusy");
      busy.style.display = "flex";

      const days = Number(document.getElementById("rangeDays").value || "7");
      const type = document.getElementById("statType").value;

      try{
        const now = new Date();
        const dates = [];
        for (let i=0;i<days;i++){
          const d = new Date(now);
          d.setDate(now.getDate() - i);
          dates.push(ymdFromDate(d));
        }

        let total = 0;
        const roomCount = new Map(); // roomKey -> bookings
        const hourCount = new Map(); // "08:00" -> count

        for (const rk of ROOMS.map(r=>r.key)){
          roomCount.set(rk, 0);
          for (const ymd of dates){
            let items = [];
            try{
              items = await loadBookings(rk, ymd);
            }catch(_){
              items = [];
            }
            total += items.length;
            roomCount.set(rk, (roomCount.get(rk) || 0) + items.length);

            // count by start hour
            for (const it of items){
              const h = (it.start || "").slice(0,2) + ":00";
              hourCount.set(h, (hourCount.get(h) || 0) + 1);
            }
          }
        }

        // derive top room/hour
        let topRoomKey = null, topRoomVal = -1;
        for (const [k,v] of roomCount.entries()){
          if (v > topRoomVal){ topRoomVal = v; topRoomKey = k; }
        }
        const topRoomName = ROOMS.find(r=>r.key===topRoomKey)?.name || "-";

        let topHour = "-", topHourVal = -1;
        for (const [h,v] of hourCount.entries()){
          if (v > topHourVal){ topHourVal = v; topHour = h; }
        }

        document.getElementById("statTotal").textContent = total;
        document.getElementById("statTopRoom").textContent = topRoomName.replace("ห้อง ","");
        document.getElementById("statTopHour").textContent = topHour;

        if (type === "byRoom"){
          drawBarChart([...roomCount.entries()].map(([k,v]) => ({
            label: (ROOMS.find(r=>r.key===k)?.name || k).replace("ห้อง ",""),
            value: v
          })));
        } else {
          // show fixed hours 08-17
          const hours = [];
          let t="08:00";
          while (hmToMin(t) <= hmToMin("17:00")){
            hours.push(t);
            t = addMinutes(t, 60);
          }
          drawBarChart(hours.map(h=>({ label:h, value: hourCount.get(h)||0 })));
        }

        toast("อัปเดตสถิติแล้ว");

      }catch(err){
        toast(String(err.message || err));
      }finally{
        busy.style.display = "none";
      }
    }

    function drawBarChart(data){
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");

      // auto size by parent width
      canvas.width = canvas.parentElement.clientWidth - 28;

      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const W = canvas.width, H = canvas.height;
      const padL = 26, padR = 10, padT = 10, padB = 30;
      const innerW = W - padL - padR;
      const innerH = H - padT - padB;

      const maxV = Math.max(1, ...data.map(d=>d.value));
      const n = data.length;
      const gap = clamp(innerW / (n*6), 6, 16);
      const barW = (innerW - gap*(n-1)) / n;

      // axis baseline
      ctx.globalAlpha = 1;
      ctx.strokeStyle = "rgba(11,43,42,.14)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT + innerH);
      ctx.lineTo(padL + innerW, padT + innerH);
      ctx.stroke();

      // bars (default canvas color; ไม่กำหนดสีเฉพาะแบบซีเรียส — แต่ให้มันอ่านง่าย)
      for (let i=0;i<n;i++){
        const x = padL + i*(barW + gap);
        const v = data[i].value;
        const h = Math.round((v / maxV) * innerH);
        const y = padT + innerH - h;

        // bar
        ctx.fillStyle = "rgba(25, 118, 210, 0.85)";
        ctx.fillRect(x, y, barW, h);

        // value text
        ctx.fillStyle = "rgba(11,43,42,.78)";
        ctx.font = "800 12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText(String(v), x + barW/2, padT + innerH - 6);

        // label
        ctx.fillStyle = "rgba(11,43,42,.55)";
        ctx.font = "900 11px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText(data[i].label, x + barW/2, H - 10);
      }
    }

    /************************************************************
     * Tab switching
     ************************************************************/
    function setTab(name){
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === name);
      });
      document.getElementById("tab-book").style.display = (name==="book") ? "" : "none";
      document.getElementById("tab-list").style.display = (name==="list") ? "" : "none";
      document.getElementById("tab-stats").style.display = (name==="stats") ? "" : "none";
    }

    /************************************************************
     * Init
     ************************************************************/
    function wire(){
      document.querySelectorAll(".tab").forEach(b=>{
        b.addEventListener("click", () => setTab(b.dataset.tab));
      });

      document.getElementById("startTime").addEventListener("change", validateTimeRange);
      document.getElementById("refreshBtn").addEventListener("click", loadBookingsForSelected);

      // employee search: Enter to add (email), with smart match from list
      const empSearch = document.getElementById("empSearch");
      empSearch.addEventListener("keydown", (e)=>{
        if (e.key !== "Enter") return;
        e.preventDefault();
        const q = empSearch.value.trim();
        if (!q) return;

        // try match by email/name/nickname
        const hit = state.employees.find(x=>{
          const s = (x.email+" "+(x.name||"")+" "+(x.nickname||"")).toLowerCase();
          return s.includes(q.toLowerCase());
        });

        if (hit?.email) addChip(hit.email);
        else addChip(q); // allow manual email
        empSearch.value = "";
      });

      document.getElementById("closeModal").onclick = () => showModal(false);
      document.getElementById("cancelBtn").onclick = () => showModal(false);
      document.getElementById("confirmBtn").onclick = confirmBooking;

      document.getElementById("loadListBtn").onclick = loadList;
      document.getElementById("updateStatsBtn").onclick = updateStats;

      // default filterDate = today
      document.getElementById("filterDate").value = ymdToday();
    }

    async function init(){
      wire();
      buildTimeOptions();

      // calendar init to current month
      const now = new Date();
      state.calYear = now.getFullYear();
      state.calMonth = now.getMonth();
      state.selected = ymdToday();

      renderCalendar();
      updateDayTitle();

      await ping();
      await loadEmployees();
      renderChips();

      await loadBookingsForSelected();
    }

    init();
  </script>
</body>
</html>
