<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESS - Meeting Rooms</title>
  <style>

    :root{
      /* ===== Theme ===== */
      --bg: #f6f7fb;
      --card: #ffffff;
      --surface: rgba(255,255,255,.78);
      --ink: #0f172a;
      --muted:#64748b;
      --line: rgba(15,23,42,.10);

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --danger:#dc2626;
      --warn:#d97706;
      --ok:#16a34a;

      --shadow: 0 18px 60px rgba(15,23,42,.10);
      --shadowSoft: 0 10px 30px rgba(15,23,42,.08);

      --r: 22px;
      --r2: 18px;

      /* Layout */
      --max: 1200px;
      --pad: clamp(14px, 2.2vw, 24px);
      --gap: clamp(12px, 1.6vw, 16px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 12% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(760px 360px at 92% -16%, rgba(168,85,247,.10), transparent 60%),
        radial-gradient(980px 520px at 80% 108%, rgba(245,158,11,.10), transparent 60%),
        var(--bg);
    }

    /* ===== Container ===== */
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: var(--pad);
    }

    /* ===== Top bar (Mobile-first) ===== */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brandRow{
      display:flex;
      align-items:flex-start;
      gap: 12px;
      min-width: 0;
    }

    .brandLogo{
      width: clamp(96px, 16vw, 160px);
      height: auto;
      display:block;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(15,23,42,.10));
    }

    .titleCol{min-width:0}
    h1{
      margin:0;
      font-size: clamp(16px, 2.0vw, 20px);
      letter-spacing:.2px;
      line-height:1.15;
      font-weight: 900;
    }
    .sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadowSoft);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 6px rgba(22,163,74,.12)}
    .dot.no{background:var(--danger); box-shadow:0 0 0 6px rgba(220,38,38,.12)}

    /* ===== Rooms grid (keep desktop close to mobile) ===== */
    .rooms{
      display:grid;
      gap: var(--gap);
      grid-template-columns: 1fr;              /* phone */
      align-items:stretch;
    }
    /* tablet/desktop: 2 columns like mobile layout */
    @media (min-width: 760px){
      .rooms{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    /* very wide: still 4 cards in one row, but keep size close to mobile */
    @media (min-width: 1180px){
      .rooms{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    /* ===== Room card ===== */
    .roomCard{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 26px;
      background: rgba(255,255,255,.82);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease;
      isolation:isolate;
    }
    .roomCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 22px 70px rgba(15,23,42,.14);
    }

    .roomCard::before{
      content:"";
      position:absolute; inset:0;
      border-radius:26px;
      pointer-events:none;
      border: 1px solid rgba(255,255,255,.55);
      z-index:0;
    }

    .roomCard::after{
      content:"";
      position:absolute;
      inset:-140px -140px auto auto;
      width: 360px;
      height: 360px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(var(--accent-rgb), .18), transparent 60%);
      filter: blur(0px);
      pointer-events:none;
      z-index:0;
    }

    .screen{
      position:relative;
      z-index:1;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      height:100%;
    }

    /* ===== Status bar ===== */
    .statusBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      backdrop-filter: blur(10px);
    }
    .statusLeft{min-width:0; display:flex; flex-direction:column; gap:2px}
    .statusLabel{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
      min-width:0;
    }
    .statusDot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(var(--accent-rgb), .95);
      box-shadow: 0 0 0 6px rgba(var(--accent-rgb), .12);
      flex:0 0 auto;
    }
    .statusMeta{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .roomChip{
      display:inline-flex;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      color: rgba(15,23,42,.86);
      font-size: 12px;
      font-weight: 900;
      flex:0 0 auto;
    }

    /* ===== Image zone =====
       - ให้รูป "พอดีกับกล่อง" แบบที่คุณต้องการ:
       - ใช้ object-fit: contain และปรับ padding ตามขนาดจอ
    */
    .stoneBox{
      border-radius: 20px;
      border: 1px solid rgba(15,23,42,.10);
      background:
        radial-gradient(720px 260px at 28% 14%, rgba(var(--accent-rgb), .10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(247,249,253,.98));
      overflow:hidden;
      height: clamp(170px, 22vw, 220px);
      padding: clamp(10px, 1.3vw, 14px);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .stoneImg{
      width: 100%;
      height: 100%;
      object-fit: contain; /* ✅ ไม่ครอป ให้เห็นเต็มก้อน */
      object-position: center;
      border-radius: 16px;
      max-width:100%;
      max-height:100%;
      filter: saturate(1.03) contrast(1.03);
      transform: translateZ(0);
    }

    /* ===== Info ===== */
    .info{
      margin-top:auto;
      border-radius: 20px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.96);
      padding: 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .roomName{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .roomName span:first-child{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .ctaRow{display:flex; gap:10px; align-items:center}
    .ctaBtn{
      width:100%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(var(--accent-rgb), .12);
      color: rgba(15,23,42,.92);
      font-size: 13px;
      font-weight: 950;
      transition: background .14s ease, transform .14s ease;
    }
    .ctaBtn:hover{ background: rgba(var(--accent-rgb), .16); }
    .ctaBtn:active{ transform: translateY(1px); }

    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    /* ===== Modals (keep consistent on mobile/desktop) ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.42);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
      z-index: 50;
    }

    .modal{
      width: min(980px, 100%);
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(15,23,42,.14);
      border-radius: 22px;
      box-shadow: 0 40px 120px rgba(15,23,42,.28);
      overflow:hidden;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(247,249,253,.96));
    }
    .modalTitle{font-weight: 950}
    .modalBody{padding: 14px 16px}
    .modalFooter{
      padding: 14px 16px;
      border-top: 1px solid rgba(15,23,42,.10);
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      background: rgba(247,249,253,.96);
    }

    .xbtn{
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      color:var(--ink);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
    }
    .xbtn:hover{ background: rgba(15,23,42,.04); }

    .grid2{display:grid; grid-template-columns: 1fr; gap: 12px;}
    @media (min-width: 820px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;
      padding: 10px 10px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      font-size: 14px;
      outline:none;
      background:#fff;
      color: var(--ink);
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.14);
    }

    .btn{
      appearance:none;
      border:0;
      border-radius: 14px;
      padding: 10px 14px;
      cursor:pointer;
      font-weight: 950;
      background: var(--primary);
      color: #fff;
    }
    .btn:hover{ background: var(--primary2); }
    .btn.ghost{
      background:#fff;
      border: 1px solid rgba(15,23,42,.14);
      color: var(--ink);
    }
    .btn.ghost:hover{ background: rgba(15,23,42,.04); }
    .btn.danger{ background: var(--danger); }

    /* Booking list */
    .list{
      border:1px solid rgba(15,23,42,.12);
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
    }
    .listHead,.listRow{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      padding: 10px 12px;
      align-items:center;
    }
    @media (min-width: 820px){
      .listHead,.listRow{ grid-template-columns: 140px 1fr 200px 1fr; }
    }
    .listHead{
      background: rgba(247,249,253,.96);
      color: var(--muted);
      font-size: 12px;
      font-weight: 850;
      border-bottom: 1px solid rgba(15,23,42,.10);
    }
    .listRow{
      border-bottom: 1px solid rgba(15,23,42,.08);
      font-size: 13px;
      color: var(--ink);
      background:#fff;
    }
    .listRow:last-child{border-bottom:0}

    /* chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      border:1px solid rgba(15,23,42,.12);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      min-height: 46px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.08);
      font-size: 12px;
      color: var(--ink);
    }
    .chip .x{
      width:18px;height:18px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(15,23,42,.14);
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .chip .x:hover{ background: rgba(15,23,42,.06); }

    /* Log (hidden already, keep safe) */
    pre{
      margin: 12px 0 0;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius: 16px;
      padding: 12px;
      color: var(--ink);
      overflow:auto;
      min-height: 120px;
      font-size: 12px;
      box-shadow: var(--shadowSoft);
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brandRow">
        <img class="brandLogo" src="MLS Logo.png" alt="MapPointAsia Logistics Solutions">
        <div class="titleCol">
          <h1>ESS (Employee Self Service)</h1>
          <div class="sub">Meeting Rooms • ดูสถานะห้องประชุม และทำการจอง</div>
        </div>
      </div>
      <div class="badge">
        <span class="dot no" id="statusDot"></span>
        <span id="statusText">Loading…</span>
      </div>
    </div>

    <div class="rooms" id="rooms"></div>

    <pre id="log" hidden></pre>
  </div>

  <!-- Modal: Room status -->
  <div class="modalOverlay" id="mRoom">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="mRoomTitle">Room</div>
          <div class="hint" id="mRoomSub">ดูการจองตามวัน</div>
        </div>
        <button class="xbtn" id="mRoomClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div>
            <label>เลือกวันที่</label>
            <input type="date" id="mRoomDate">
            <div class="hint">แสดงเป็น วว/ดด/ปี(ค.ศ.) ใน UI และส่งเป็น YYYY-MM-DD</div>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-end;justify-content:flex-end">
            <button class="btn ghost" id="mRoomRefresh">รีเฟรชรายการ</button>
            <button class="btn" id="mRoomBookBtn">จองห้องนี้</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="list" id="mRoomList">
          <div class="listHead">
            <div>เวลา</div>
            <div>หัวข้อ</div>
            <div>แผนก</div>
            <div>ผู้จอง</div>
          </div>
          <div id="mRoomRows"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn ghost" id="mRoomClose2">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Modal: Booking form -->
  <div class="modalOverlay" id="mBook">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="mBookTitle">จองห้อง</div>
          <div class="hint" id="mBookRoomHint">-</div>
        </div>
        <button class="xbtn" id="mBookClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div>
            <label>วันที่ (วว/ดด/ปี ค.ศ.)</label>
            <input type="date" id="bkDate">
          </div>
          <div>
            <label>ช่วงเวลา</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div>
                <select id="bkStart"></select>
                <div class="hint">เริ่ม</div>
              </div>
              <div>
                <select id="bkEnd"></select>
                <div class="hint">สิ้นสุด</div>
              </div>
            </div>
          </div>

          <div>
            <label>แผนก (Department)</label>
            <select id="bkDept"></select>
            <div class="hint">ถ้าไม่เลือกแผนก → ชื่อผู้จองจะไม่ให้เลือก</div>
          </div>

          <div>
            <label>ชื่อผู้จอง (Name)</label>
            <select id="bkName" disabled></select>
            <div class="hint">รายชื่อจะเป็นเฉพาะพนักงานในแผนกนั้น</div>
          </div>

          <div style="grid-column:1/-1">
            <label>อีเมลผู้จอง (Auto)</label>
            <input id="bkEmail" disabled placeholder="เลือกชื่อผู้จองแล้วจะแสดงอีเมลอัตโนมัติ">
          </div>

          <div style="grid-column:1/-1">
            <label>รายละเอียดการประชุม</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn ghost" id="btnDetails" type="button">เพิ่มรายละเอียดการประชุม</button>
              <button class="btn ghost" id="btnMembers" type="button">เพิ่มสมาชิกการประชุม</button>
              <span class="pill" id="pillDetails">หัวข้อ: ยังไม่ระบุ</span>
              <span class="pill" id="pillMembers">สมาชิก: 0 คน</span>
            </div>
            <div class="hint">หัวข้อประชุมบังคับต้องกรอก (required)</div>
          </div>

          <div style="grid-column:1/-1">
            <label>สมาชิกที่เข้าร่วม (สรุป)</label>
            <div class="chips" id="membersChips"></div>
            <div class="hint">ระบบจะส่งเป็นอีเมลคั่นด้วย comma ไปยัง Bookings</div>
          </div>
        </div>

        <pre id="bkLog"></pre>
      </div>

      <div class="modalFooter">
        <button class="btn ghost" id="mBookCancel">ยกเลิก</button>
        <button class="btn" id="mBookSave">บันทึกการจอง</button>
      </div>
    </div>
  </div>

  <!-- Modal: Meeting details -->
  <div class="modalOverlay" id="mDetails">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">รายละเอียดการประชุม</div>
          <div class="hint">กดบันทึกแล้วปิด pop-up ทันที</div>
        </div>
        <button class="xbtn" id="mDetailsClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div style="grid-column:1/-1">
            <label>หัวข้อการประชุม (บังคับ)</label>
            <input id="dtTitle" placeholder="ใส่หัวข้อการประชุม">
          </div>
          <div style="grid-column:1/-1">
            <label>รายละเอียดการประชุม</label>
            <textarea id="dtDesc" placeholder="ใส่รายละเอียดเพิ่มเติม"></textarea>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn ghost" id="mDetailsCancel">ยกเลิก</button>
        <button class="btn" id="mDetailsSave">บันทึก</button>
      </div>
    </div>
  </div>

  <!-- Modal: Members picker -->
  <div class="modalOverlay" id="mMembers">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">เพิ่มสมาชิกการประชุม</div>
          <div class="hint">เลือกแผนก → เลือกสมาชิก (สลับแผนกได้หลายครั้ง) → บันทึกสมาชิกแล้วปิด</div>
        </div>
        <button class="xbtn" id="mMembersClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div>
            <label>แผนก</label>
            <select id="mbDept"></select>
          </div>
          <div>
            <label>สมาชิกในแผนก</label>
            <select id="mbName"></select>
          </div>
          <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end">
            <button class="btn ghost" id="mbAdd">เพิ่มสมาชิก</button>
            <button class="btn ghost" id="mbClear">ล้างทั้งหมด</button>
          </div>
          <div style="grid-column:1/-1">
            <label>สมาชิกที่เลือก</label>
            <div class="chips" id="mbChips"></div>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn ghost" id="mMembersCancel">ยกเลิก</button>
        <button class="btn" id="mMembersSave">บันทึกสมาชิก</button>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyLp9bB6QHjPZ8KRf1FqGJ5am-ubfJqHE2pxgCxX_szEHnOEX8wjlIukDCupjOmC9wSow/exec";
  const API_KEY = "ESS-ROOM-2026";
  const TZ_OFFSET = "+07:00";

  // ====== STATE ======
  const state = {
    employees: [],
    departments: [],
    roomKey: null,
    roomName: null,
    roomDate: null,
    roomBookings: [],
    booking: {
      roomKey: "",
      date: "",
      start: "08:30",
      end: "17:30",
      dept: "",
      name: "",
      email: "",
      title: "",
      desc: "",
      members: new Map()
    }
  };

  // ====== DOM ======
  const logEl = document.getElementById("log");
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const roomsEl = document.getElementById("rooms");

  const mRoom = document.getElementById("mRoom");
  const mRoomTitle = document.getElementById("mRoomTitle");
  const mRoomDate = document.getElementById("mRoomDate");
  const mRoomRows = document.getElementById("mRoomRows");

  const mBook = document.getElementById("mBook");
  const mBookTitle = document.getElementById("mBookTitle");
  const mBookRoomHint = document.getElementById("mBookRoomHint");
  const bkDate = document.getElementById("bkDate");
  const bkStart = document.getElementById("bkStart");
  const bkEnd = document.getElementById("bkEnd");
  const bkDept = document.getElementById("bkDept");
  const bkName = document.getElementById("bkName");
  const bkEmail = document.getElementById("bkEmail");
  const pillDetails = document.getElementById("pillDetails");
  const pillMembers = document.getElementById("pillMembers");
  const membersChips = document.getElementById("membersChips");
  const bkLog = document.getElementById("bkLog");

  const mDetails = document.getElementById("mDetails");
  const dtTitle = document.getElementById("dtTitle");
  const dtDesc = document.getElementById("dtDesc");

  const mMembers = document.getElementById("mMembers");
  const mbDept = document.getElementById("mbDept");
  const mbName = document.getElementById("mbName");
  const mbChips = document.getElementById("mbChips");

  // ====== Helpers ======
  const pad = (n) => String(n).padStart(2,"0");
  const nowDateTH = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const tomorrow = () => {
    const d = new Date();
    d.setDate(d.getDate()+1);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  function setStatus(ok, text){
    statusDot.className = "dot " + (ok ? "ok" : "no");
    statusText.textContent = text;
  }
  function log(msg){ logEl.textContent += msg + "\n"; }
  function clearLog(){ logEl.textContent = ""; }
  function clearBkLog(){ bkLog.textContent = ""; }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function isValidEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||"").trim());
  }
  function makeISO(dateYYYYMMDD, hhmm){
    const [y,m,d] = dateYYYYMMDD.split("-").map(Number);
    const [hh,mm] = hhmm.split(":").map(Number);
    return `${pad(y)}-${pad(m)}-${pad(d)}T${pad(hh)}:${pad(mm)}:00${TZ_OFFSET}`;
  }
  function isPast(iso){ return new Date(iso).getTime() <= Date.now(); }

  function buildTimeOptions(start="08:30", end="17:30", stepMin=30){
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let t = sh*60 + sm;
    const tEnd = eh*60 + em;
    const list = [];
    while (t <= tEnd){
      const hh = Math.floor(t/60);
      const mm = t%60;
      list.push(`${pad(hh)}:${pad(mm)}`);
      t += stepMin;
    }
    return list;
  }
  function fillSelect(sel, options, selected, placeholder){
    sel.innerHTML = "";
    if (placeholder){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = placeholder;
      sel.appendChild(o);
    }
    options.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      if (v === selected) o.selected = true;
      sel.appendChild(o);
    });
  }
  function openModal(el){ el.style.display = "flex"; }
  function closeModal(el){ el.style.display = "none"; }

  // ====== JSONP ======
  function jsonpCall(params, onDone){
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;

    const timer = setTimeout(() => {
      onDone && onDone({ ok:false, error:"TIMEOUT" });
      cleanup();
    }, 12000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch(_){}
    }

    window[cb] = (res) => { cleanup(); onDone && onDone(res); };

    const qs = new URLSearchParams();
    Object.entries(params).forEach(([k,v]) => {
      if (v === undefined || v === null) return;
      qs.set(k, String(v));
    });

    const url = `${WEBAPP_URL}?${qs.toString()}&_=${Date.now()}`;
    const s = document.createElement("script");
    s.src = url;
    s.onerror = () => {
      cleanup();
      onDone && onDone({ ok:false, error:"SCRIPT_ERROR" });
    };
    document.body.appendChild(s);
  }

  // ====== Backend API wrappers ======
  function apiEmployees(){
    return new Promise((resolve) => {
      jsonpCall({ action:"employees", apiKey:API_KEY }, resolve);
    });
  }
  function apiBookings(roomKey, dateYYYYMMDD){
    return new Promise((resolve) => {
      jsonpCall({ action:"bookings", apiKey:API_KEY, roomKey, date: dateYYYYMMDD }, resolve);
    });
  }
  function apiCreateMeeting(payload){
    return new Promise((resolve) => {
      jsonpCall({ action:"createmeeting", apiKey:API_KEY, ...payload }, resolve);
    });
  }

  // ====== UI render: Rooms (UI only) ======
  // NOTE: คุณต้องมีไฟล์รูปตาม path นี้ใน GitHub Pages repo
  const ROOMS = [
    { key:"mind",    name:"Mind Room",     stone:"Mind.png",    accentRgb:"245, 158, 11" }, // amber
    { key:"reality", name:"Reality Room",  stone:"Reality.png", accentRgb:"239, 68, 68" },  // red
    { key:"power",   name:"Power Room",    stone:"Power.png",   accentRgb:"168, 85, 247" }, // purple
    { key:"space",   name:"Space Room",    stone:"Space.png",   accentRgb:"59, 130, 246" }  // blue
  ];

  function renderRooms(){
    roomsEl.innerHTML = "";
    ROOMS.forEach(r => {
      const div = document.createElement("div");
      div.className = "roomCard";
      div.style.setProperty("--accent-rgb", r.accentRgb);

      // UI-only status text (ไม่ดึง booking มาคำนวณใน card เพื่อไม่เปลี่ยนลอจิก)
      const statusText = "Available";
      const statusMeta = "Tap to view schedule";

      div.innerHTML = `
        <div class="screen">
          <div class="statusBar">
            <div class="statusLeft">
              <div class="statusLabel">
                <span class="statusDot"></span>
                <span>${escapeHtml(statusText)}</span>
              </div>
              <div class="statusMeta">${escapeHtml(statusMeta)}</div>
            </div>
            <div class="roomChip">${escapeHtml(r.key.toUpperCase())}</div>
          </div>

          <div class="stoneBox">
            <img class="stoneImg" src="${escapeHtml(r.stone)}" alt="${escapeHtml(r.name)}">
          </div>

          <div class="info">
            <div class="roomName">
              <span>${escapeHtml(r.name)}</span>
              <span class="pill">Room</span>
            </div>

            <div class="ctaRow">
              <div class="ctaBtn">Open Room Status</div>
            </div>
          </div>
        </div>
      `;

      div.addEventListener("click", () => openRoomStatus(r.key, r.name));
      roomsEl.appendChild(div);
    });
  }

  // ====== Room Status modal ======
  async function openRoomStatus(roomKey, roomName){
    state.roomKey = roomKey;
    state.roomName = roomName;
    mRoomTitle.textContent = `${roomName} — สถานะการจอง`;
    mRoomDate.value = nowDateTH();
    state.roomDate = mRoomDate.value;

    openModal(mRoom);
    await refreshRoomBookings();
  }

  async function refreshRoomBookings(){
    const roomKey = state.roomKey;
    const date = mRoomDate.value || nowDateTH();
    state.roomDate = date;

    mRoomRows.innerHTML = `<div class="listRow"><div class="pill">กำลังโหลด…</div><div></div><div></div><div></div></div>`;
    const res = await apiBookings(roomKey, date);

    if (!res || !res.ok){
      mRoomRows.innerHTML = `<div class="listRow"><div class="pill">โหลดไม่สำเร็จ</div><div>${escapeHtml(res?.error || "unknown")}</div><div></div><div></div></div>`;
      return;
    }

    const rows = Array.isArray(res.items) ? res.items : [];
    state.roomBookings = rows;

    if (rows.length === 0){
      mRoomRows.innerHTML = `<div class="listRow"><div class="pill">ไม่มีรายการจอง</div><div></div><div></div><div></div></div>`;
      return;
    }

    mRoomRows.innerHTML = "";
    rows.forEach(it => {
      const div = document.createElement("div");
      div.className = "listRow";
      div.innerHTML = `
        <div><span class="pill">${escapeHtml(it.start)}–${escapeHtml(it.end)}</span></div>
        <div>${escapeHtml(it.title || "-")}</div>
        <div>${escapeHtml(it.department || "-")}</div>
        <div>${escapeHtml(it.booker || "-")}</div>
      `;
      mRoomRows.appendChild(div);
    });
  }

  // ====== Booking modal (main) ======
  function resetBookingState(){
    state.booking = {
      roomKey: state.roomKey || "",
      date: tomorrow(),
      start: "08:30",
      end: "17:30",
      dept: "",
      name: "",
      email: "",
      title: "",
      desc: "",
      members: new Map()
    };
  }

  function renderMembersChips(){
    membersChips.innerHTML = "";
    const arr = Array.from(state.booking.members.values());
    pillMembers.textContent = `สมาชิก: ${arr.length} คน`;

    if (arr.length === 0){
      membersChips.innerHTML = `<span class="pill">ยังไม่มีสมาชิก</span>`;
      return;
    }
    arr.forEach(m => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `
        <span><b>${escapeHtml(m.name || m.email)}</b> — ${escapeHtml(m.department || "-")}</span>
        <span style="opacity:.8">${escapeHtml(m.email)}</span>
        <span class="x" title="ลบ">×</span>
      `;
      chip.querySelector(".x").addEventListener("click", () => {
        state.booking.members.delete(m.email);
        renderMembersChips();
      });
      membersChips.appendChild(chip);
    });
  }

  function openBookingModal(){
    resetBookingState();

    const times = buildTimeOptions("08:30","17:30",30);
    fillSelect(bkStart, times, state.booking.start);
    fillSelect(bkEnd, times, state.booking.end);

    bkDate.value = state.booking.date;

    fillSelect(bkDept, state.departments, "", "— เลือกแผนก —");
    bkName.innerHTML = "";
    bkName.disabled = true;
    bkEmail.value = "";

    pillDetails.textContent = "หัวข้อ: ยังไม่ระบุ";
    dtTitle.value = "";
    dtDesc.value = "";

    state.booking.members.clear();
    renderMembersChips();

    mBookTitle.textContent = "จองห้องประชุม";
    mBookRoomHint.textContent = `ห้อง: ${state.roomName} (${state.roomKey})`;

    clearBkLog();
    openModal(mBook);
  }

  function onDeptChange(){
    const dept = bkDept.value;
    state.booking.dept = dept;

    if (!dept){
      bkName.disabled = true;
      bkName.innerHTML = "";
      bkEmail.value = "";
      return;
    }

    const list = state.employees
      .filter(e => (e.department || "") === dept)
      .map(e => ({ label: e.name || e.email, value: e.email, name: e.name || "", email: e.email }));

    bkName.disabled = false;
    bkName.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "— เลือกชื่อผู้จอง —";
    bkName.appendChild(ph);

    list.forEach(it => {
      const o = document.createElement("option");
      o.value = it.email;
      o.textContent = it.label;
      o.dataset.name = it.name;
      o.dataset.email = it.email;
      bkName.appendChild(o);
    });

    bkEmail.value = "";
    state.booking.name = "";
    state.booking.email = "";
  }

  function onNameChange(){
    const email = bkName.value;
    if (!email){
      bkEmail.value = "";
      state.booking.name = "";
      state.booking.email = "";
      return;
    }
    const opt = bkName.options[bkName.selectedIndex];
    const name = opt?.dataset?.name || "";
    bkEmail.value = email;
    state.booking.name = name;
    state.booking.email = email;

    if (!state.booking.members.has(email)){
      state.booking.members.set(email, { email, name, department: state.booking.dept });
      renderMembersChips();
    }
  }

  // ====== Details modal ======
  function openDetailsModal(){
    openModal(mDetails);
    dtTitle.value = state.booking.title || dtTitle.value || "";
    dtDesc.value = state.booking.desc || dtDesc.value || "";
  }
  function saveDetails(){
    const title = (dtTitle.value || "").trim();
    if (!title){
      alert("หัวข้อการประชุม (บังคับ) ต้องกรอก");
      return;
    }
    state.booking.title = title;
    state.booking.desc = (dtDesc.value || "").trim();
    pillDetails.textContent = `หัวข้อ: ${title}`;
    closeModal(mDetails);
  }

  // ====== Members modal ======
  function openMembersModal(){
    fillSelect(mbDept, state.departments, "", "— เลือกแผนก —");
    mbName.innerHTML = "";
    mbChips.innerHTML = "";
    renderMbChips();
    openModal(mMembers);
  }

  function renderMbChips(){
    mbChips.innerHTML = "";
    const arr = Array.from(state.booking.members.values());
    if (arr.length === 0){
      mbChips.innerHTML = `<span class="pill">ยังไม่มีสมาชิก</span>`;
      return;
    }
    arr.forEach(m => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `
        <span><b>${escapeHtml(m.name || m.email)}</b> — ${escapeHtml(m.department || "-")}</span>
        <span style="opacity:.8">${escapeHtml(m.email)}</span>
        <span class="x" title="ลบ">×</span>
      `;
      chip.querySelector(".x").addEventListener("click", () => {
        state.booking.members.delete(m.email);
        renderMbChips();
      });
      mbChips.appendChild(chip);
    });
  }

  function onMbDeptChange(){
    const dept = mbDept.value;
    mbName.innerHTML = "";
    if (!dept){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "เลือกแผนกก่อน";
      mbName.appendChild(o);
      return;
    }

    const list = state.employees.filter(e => (e.department||"") === dept);
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "— เลือกสมาชิก —";
    mbName.appendChild(ph);

    list.forEach(e => {
      const o = document.createElement("option");
      o.value = e.email;
      o.textContent = e.name || e.email;
      o.dataset.name = e.name || "";
      o.dataset.dept = e.department || "";
      mbName.appendChild(o);
    });
  }

  function mbAddMember(){
    const email = mbName.value;
    if (!email) return;
    const opt = mbName.options[mbName.selectedIndex];
    const name = opt?.dataset?.name || "";
    const dept = opt?.dataset?.dept || mbDept.value || "";
    if (!state.booking.members.has(email)){
      state.booking.members.set(email, { email, name, department: dept });
    }
    renderMbChips();
  }

  function mbClearAll(){
    state.booking.members.clear();
    renderMbChips();
  }

  function mbSaveAndClose(){
    renderMembersChips();
    closeModal(mMembers);
  }

  // ====== Save booking ======
  async function saveBooking(){
    clearBkLog();

    const date = bkDate.value || "";
    const start = bkStart.value;
    const end = bkEnd.value;

    const dept = bkDept.value || "";
    const bookerEmail = bkEmail.value || "";
    const title = (state.booking.title || "").trim();
    const desc = (state.booking.desc || "").trim();

    if (!date){ bkLog.textContent += "ERROR: ต้องเลือกวันที่\n"; alert("ต้องเลือกวันที่"); return; }
    if (!start || !end){ bkLog.textContent += "ERROR: ต้องเลือกเวลา\n"; alert("ต้องเลือกเวลา"); return; }
    if (!dept){ bkLog.textContent += "ERROR: ต้องเลือกแผนก\n"; alert("ต้องเลือกแผนก"); return; }
    if (!bookerEmail || !isValidEmail(bookerEmail)){ bkLog.textContent += "ERROR: ต้องเลือกชื่อผู้จองเพื่อได้อีเมล\n"; alert("ต้องเลือกชื่อผู้จอง"); return; }
    if (!title){ bkLog.textContent += "ERROR: ต้องใส่หัวข้อการประชุม (required)\n"; alert("ต้องใส่หัวข้อการประชุม"); return; }

    const startISO = makeISO(date, start);
    const endISO = makeISO(date, end);

    if (new Date(endISO).getTime() <= new Date(startISO).getTime()){
      bkLog.textContent += "ERROR: เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม\n";
      alert("เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม");
      return;
    }
    if (isPast(startISO)){
      bkLog.textContent += "ERROR: ห้ามจองเวลาที่ผ่านมาแล้ว\n";
      alert("ห้ามจองเวลาที่ผ่านมาแล้ว");
      return;
    }

    const members = Array.from(state.booking.members.keys());
    if (!members.includes(bookerEmail)) members.unshift(bookerEmail);
    const attendees = members.join(", ");

    const payload = {
      roomKey: state.roomKey,
      title,
      start: startISO,
      end: endISO,
      attendees,
      description: desc,
      bookerEmail
    };

    bkLog.textContent += "REQUEST:\n" + JSON.stringify(payload, null, 2) + "\n";

    const res = await apiCreateMeeting(payload);

    bkLog.textContent += "RESPONSE:\n" + JSON.stringify(res, null, 2) + "\n";

    if (res && res.ok){
      alert("บันทึกการจองเรียบร้อย");
      closeModal(mBook);
      await refreshRoomBookings();
    } else {
      alert("บันทึกล้มเหลว: " + (res?.error || "unknown"));
    }
  }

  // ====== Init: load employees ======
  async function init(){
    clearLog();
    renderRooms();

    setStatus(false, "Loading employees…");
    log("Loading employees…");
    const res = await apiEmployees();

    if (!res || !res.ok || !Array.isArray(res.employees)){
      setStatus(false, "Employees load failed");
      log("Employees load failed: " + JSON.stringify(res));
      return;
    }

    state.employees = res.employees.map(e => ({
      email: (e.email||"").toLowerCase(),
      name: e.name || "",
      department: e.department || "",
      nickname: e.nickname || "",
      position: e.position || ""
    }));

    const deps = new Set();
    state.employees.forEach(e => { if (e.department) deps.add(e.department); });
    state.departments = Array.from(deps).sort((a,b)=>a.localeCompare(b));

    setStatus(true, `Ready (${state.employees.length} employees)`);
    log(`Employees loaded: ${state.employees.length}`);
    log(`Departments: ${state.departments.length}`);
  }

  // ====== Event wiring ======
  document.getElementById("mRoomClose").onclick = () => closeModal(mRoom);
  document.getElementById("mRoomClose2").onclick = () => closeModal(mRoom);
  document.getElementById("mRoomRefresh").onclick = () => refreshRoomBookings();
  mRoomDate.addEventListener("change", () => refreshRoomBookings());
  document.getElementById("mRoomBookBtn").onclick = () => { closeModal(mRoom); openBookingModal(); };

  document.getElementById("mBookClose").onclick = () => closeModal(mBook);
  document.getElementById("mBookCancel").onclick = () => closeModal(mBook);
  bkDept.addEventListener("change", onDeptChange);
  bkName.addEventListener("change", onNameChange);
  document.getElementById("btnDetails").onclick = () => openDetailsModal();
  document.getElementById("btnMembers").onclick = () => openMembersModal();
  document.getElementById("mBookSave").onclick = () => saveBooking();

  document.getElementById("mDetailsClose").onclick = () => closeModal(mDetails);
  document.getElementById("mDetailsCancel").onclick = () => closeModal(mDetails);
  document.getElementById("mDetailsSave").onclick = () => saveDetails();

  document.getElementById("mMembersClose").onclick = () => closeModal(mMembers);
  document.getElementById("mMembersCancel").onclick = () => closeModal(mMembers);
  mbDept.addEventListener("change", onMbDeptChange);
  document.getElementById("mbAdd").onclick = () => mbAddMember();
  document.getElementById("mbClear").onclick = () => mbClearAll();
  document.getElementById("mMembersSave").onclick = () => mbSaveAndClose();

  [mRoom, mBook, mDetails, mMembers].forEach(ov => {
    ov.addEventListener("click", (e) => { if (e.target === ov) closeModal(ov); });
  });

  init();
</script>
</body>
</html>
