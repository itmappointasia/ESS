<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meeting Room Booking</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Kanit', sans-serif; }
    .room-mind { background: linear-gradient(135deg, #F5D547 0%, #FFD700 100%); }
    .room-reality { background: linear-gradient(135deg, #FF2D55 0%, #FF1744 100%); }
    .room-power { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .room-space { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
    .room-mind-light { background: rgba(245, 213, 71, 0.15); border-left: 3px solid #F5D547; }
    .room-reality-light { background: rgba(255, 45, 85, 0.15); border-left: 3px solid #FF2D55; }
    .room-power-light { background: rgba(156, 39, 176, 0.15); border-left: 3px solid #9C27B0; }
    .room-space-light { background: rgba(33, 150, 243, 0.15); border-left: 3px solid #2196F3; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .time-slot:hover { background: rgba(245, 213, 71, 0.1); }
    .booking-card { transition: all 0.2s ease; }
    .booking-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .modal-overlay { backdrop-filter: blur(4px); }
    .date-picker-day{
      padding: 0.5rem; text-align: center; font-size: 0.875rem;
      cursor: pointer; border-radius: 0.5rem; transition: all 0.2s;
      border: 1px solid transparent;
    }
    .date-picker-day:hover { background: rgba(245, 213, 71, 0.1); }
    .date-picker-day.other-month { color: #cbd5e1; }
    .date-picker-day.selected { background: #F5D547; color: white; font-weight: 600; }
    .date-picker-day.today { border: 2px solid #F5D547; }
    .date-picker-day.disabled { color: #cbd5e1; cursor: not-allowed; }
    .slide-in { animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity:0; transform: translateY(-10px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>

<body class="h-full bg-slate-50 overflow-auto">
  <div id="app" class="h-full w-full flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 room-mind rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <h1 id="app-title" class="text-xl font-semibold text-slate-800">Meeting Room Booking</h1>
          <p class="text-xs text-slate-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet/Calendar)</p>
          <p id="api-status" class="text-[11px] text-slate-400 mt-0.5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶</p>
        </div>
      </div>

      <button onclick="openBookingModal()" class="bg-emerald-200 text-emerald-900 px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-emerald-300 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
      </button>
    </header>

    <!-- Navigation -->
    <div class="bg-white border-b border-slate-200 px-4 py-2 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-2">
        <button onclick="navigateMonth(-1)" class="p-2 hover:bg-slate-100 rounded-lg transition">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <button onclick="goToToday()" class="px-3 py-1.5 text-sm font-medium text-emerald-900 bg-emerald-200 hover:bg-emerald-300 rounded-lg transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>

        <button onclick="navigateMonth(1)" class="p-2 hover:bg-slate-100 rounded-lg transition">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <h2 id="current-month" class="text-lg font-semibold text-slate-800 ml-2"></h2>
      </div>

      <div class="flex items-center gap-2">
        <select id="view-mode" onchange="changeView(this.value)"
          class="px-3 py-1.5 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
          <option value="month">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
          <option value="week">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
          <option value="day">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ß‡∏±‡∏ô</option>
        </select>

        <select id="room-filter" onchange="filterByRoom(this.value)"
          class="px-3 py-1.5 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
          <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
          <option value="Mind Room">üü° Mind Room</option>
          <option value="Reality Room">üî¥ Reality Room</option>
          <option value="Power Room">üü£ Power Room</option>
          <option value="Space Room">üîµ Space Room</option>
        </select>
      </div>
    </div>

    <!-- Room Legend -->
    <div class="bg-white border-b border-slate-200 px-4 py-2 flex items-center gap-4 flex-shrink-0 overflow-x-auto">
      <span class="text-sm text-slate-500 flex-shrink-0">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</span>
      <div class="flex items-center gap-1 flex-shrink-0"><span class="w-3 h-3 rounded-full room-mind"></span> <span class="text-sm text-slate-700">Mind Room</span></div>
      <div class="flex items-center gap-1 flex-shrink-0"><span class="w-3 h-3 rounded-full room-reality"></span> <span class="text-sm text-slate-700">Reality Room</span></div>
      <div class="flex items-center gap-1 flex-shrink-0"><span class="w-3 h-3 rounded-full room-power"></span> <span class="text-sm text-slate-700">Power Room</span></div>
      <div class="flex items-center gap-1 flex-shrink-0"><span class="w-3 h-3 rounded-full room-space"></span> <span class="text-sm text-slate-700">Space Room</span></div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar-container" class="flex-1 overflow-auto p-4"></div>
  </div>

  <!-- Booking Modal -->
  <div id="booking-modal" class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90%] overflow-y-auto slide-in">
      <div class="p-6 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <h3 id="modal-title" class="text-xl font-semibold text-slate-800">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
          <button onclick="closeBookingModal()" class="p-2 hover:bg-slate-100 rounded-lg transition">
            <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <form id="booking-form" class="p-6 space-y-4">
        <input type="hidden" id="booking-id" />

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Booker Email) *</label>
          <input type="email" id="booking-booker-email" required
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô staff@company.com" />
          <p class="text-xs text-slate-400 mt-1">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Backend (lookup ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏µ‡∏ï + ‡∏™‡πà‡∏á invite)</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° *</label>
          <input type="text" id="booking-title" required
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° Marketing" />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° *</label>
          <div class="grid grid-cols-2 gap-2">
            <label class="cursor-pointer">
              <input type="radio" name="room" value="Mind Room" class="peer hidden" required />
              <div class="p-3 border-2 border-slate-200 rounded-lg peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition">
                <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full room-mind"></span><span class="font-medium text-slate-700">Mind Room</span></div>
              </div>
            </label>

            <label class="cursor-pointer">
              <input type="radio" name="room" value="Reality Room" class="peer hidden" />
              <div class="p-3 border-2 border-slate-200 rounded-lg peer-checked:border-red-500 peer-checked:bg-red-50 transition">
                <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full room-reality"></span><span class="font-medium text-slate-700">Reality Room</span></div>
              </div>
            </label>

            <label class="cursor-pointer">
              <input type="radio" name="room" value="Power Room" class="peer hidden" />
              <div class="p-3 border-2 border-slate-200 rounded-lg peer-checked:border-purple-500 peer-checked:bg-purple-50 transition">
                <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full room-power"></span><span class="font-medium text-slate-700">Power Room</span></div>
              </div>
            </label>

            <label class="cursor-pointer">
              <input type="radio" name="room" value="Space Room" class="peer hidden" />
              <div class="p-3 border-2 border-slate-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 transition">
                <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full room-space"></span><span class="font-medium text-slate-700">Space Room</span></div>
              </div>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
            <div class="relative">
              <input type="text" id="booking-date-display" required
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none cursor-pointer bg-white"
                onclick="toggleDatePicker()" readonly placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" />
              <input type="hidden" id="booking-date" />

              <div id="date-picker" class="hidden absolute top-full left-0 mt-2 bg-white border border-slate-200 rounded-lg shadow-xl z-20 p-4 w-80">
                <div class="flex items-center justify-between mb-4">
                  <button type="button" onclick="prevPickerMonth()" class="p-1.5 hover:bg-slate-100 rounded-lg transition">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>

                  <div class="text-center">
                    <div id="picker-month-label" class="font-semibold text-slate-800"></div>
                  </div>

                  <button type="button" onclick="nextPickerMonth()" class="p-1.5 hover:bg-slate-100 rounded-lg transition">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>

                <div class="grid grid-cols-7 gap-1 mb-2">
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏≠‡∏≤</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏à</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏≠</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏û</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏û‡∏§</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏®</div>
                  <div class="text-center text-xs text-slate-500 font-medium p-2">‡∏™</div>
                </div>

                <div id="date-picker-grid" class="grid grid-cols-7 gap-1"></div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <div class="w-full px-4 py-2.5 border border-slate-200 rounded-lg bg-slate-50 text-sm text-slate-600">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï + ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label>
            <select id="booking-start" required class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none"></select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î *</label>
            <select id="booking-end" required class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none"></select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
          <input type="text" id="booking-attendees"
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô john@email.com, jane@email.com" />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea id="booking-description" rows="3"
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none resize-none"
            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>

        <div id="conflict-warning" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center gap-2 text-red-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span class="text-sm font-medium">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>
          </div>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeBookingModal()"
            class="flex-1 px-4 py-2.5 border border-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-50 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" id="submit-btn"
            class="flex-1 px-4 py-2.5 bg-emerald-200 text-emerald-900 rounded-lg font-medium hover:bg-emerald-300 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <span id="toast-message"></span>
  </div>

<script>
/* ============================================================
  CONFIG (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
============================================================ */
const API_KEY_EXPECTED = "ESS-ROOM-2026";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyLp9bB6QHjPZ8KRf1FqGJ5am-ubfJqHE2pxgCxX_szEHnOEX8wjlIukDCupjOmC9wSow/exec";

/* ============================================================
  ROOM MAP
============================================================ */
const ROOM_KEYS = ["mind","reality","power","space"];
const roomKeyToName = {
  mind: "Mind Room",
  reality: "Reality Room",
  power: "Power Room",
  space: "Space Room"
};
const roomNameToKey = {
  "Mind Room": "mind",
  "Reality Room": "reality",
  "Power Room": "power",
  "Space Room": "space"
};

const roomColors = {
  'Mind Room': { class: 'room-mind', light: 'room-mind-light', hex: '#F5D547' },
  'Reality Room': { class: 'room-reality', light: 'room-reality-light', hex: '#FF2D55' },
  'Power Room': { class: 'room-power', light: 'room-power-light', hex: '#9C27B0' },
  'Space Room': { class: 'room-space', light: 'room-space-light', hex: '#2196F3' }
};

const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

/* ============================================================
  STATE
============================================================ */
let bookings = [];                 // flattened bookings for current view
let bookingsCache = new Map();     // key = `${roomKey}|${date}` => array
let currentDate = new Date();
let currentView = 'month';
let currentRoomFilter = 'all';

let pickerDate = new Date();
let selectedBooking = null;

/* ============================================================
  JSONP CLIENT (doGet ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ callback)
============================================================ */
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = `__cb_${Date.now()}_${Math.floor(Math.random()*1e6)}`;
    const query = new URLSearchParams({
      action,
      apiKey: API_KEY_EXPECTED,
      callback: cb,
      ...params
    });

    const url = `${WEBAPP_URL}?${query.toString()}`;
    const script = document.createElement("script");
    script.src = url;
    script.async = true;

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("JSONP_TIMEOUT"));
    }, 15000);

    window[cb] = (data) => {
      clearTimeout(timer);
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      clearTimeout(timer);
      cleanup();
      reject(new Error("JSONP_NETWORK_ERROR"));
    };

    function cleanup() {
      try { delete window[cb]; } catch(_) { window[cb] = undefined; }
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }

    document.body.appendChild(script);
  });
}

/* ============================================================
  TIME OPTIONS
============================================================ */
const timeOptions = [];
for (let h = 7; h <= 20; h++) {
  for (let m = 0; m < 60; m += 30) {
    timeOptions.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  }
}

function initTimeSelects() {
  const startSelect = document.getElementById('booking-start');
  const endSelect = document.getElementById('booking-end');
  startSelect.innerHTML = timeOptions.map(t => `<option value="${t}">${t}</option>`).join('');
  endSelect.innerHTML = timeOptions.map(t => `<option value="${t}">${t}</option>`).join('');
  startSelect.value = '09:00';
  endSelect.value = '10:00';
}

/* ============================================================
  UTIL
============================================================ */
function ymd(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function formatDateDisplay(dateStr) {
  const [year, month, day] = dateStr.split('-');
  return `${parseInt(day)} ${thaiMonths[parseInt(month)-1]} ${parseInt(year)+543}`;
}
function toLocalIso(dateStr, timeStr) {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Date ‡∏î‡πâ‡∏ß‡∏¢ local time ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô ISO (UTC) ‡πÉ‡∏´‡πâ backend parse ‡πÑ‡∏î‡πâ
  const d = new Date(`${dateStr}T${timeStr}:00`);
  return d.toISOString();
}
function uidFromItem(roomKey, dateStr, it) {
  // backend ‡πÑ‡∏°‡πà‡∏°‡∏µ id ‡πÄ‡∏£‡∏≤ compose ‡πÄ‡∏≠‡∏á
  const base = `${roomKey}|${dateStr}|${it.start}|${it.end}|${it.title||''}`;
  let h = 0;
  for (let i=0;i<base.length;i++) h = ((h<<5)-h) + base.charCodeAt(i) | 0;
  return `b_${Math.abs(h)}`;
}
function showToast(message) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-message').textContent = message;
  toast.classList.remove('translate-y-20','opacity-0');
  setTimeout(() => toast.classList.add('translate-y-20','opacity-0'), 3000);
}

/* ============================================================
  BACKEND LOAD: bookings(roomKey,date)
============================================================ */
async function loadBookingsFor(roomKey, dateStr) {
  const cacheKey = `${roomKey}|${dateStr}`;
  if (bookingsCache.has(cacheKey)) return bookingsCache.get(cacheKey);

  const res = await apiJsonp("bookings", { roomKey, date: dateStr });
  if (!res || !res.ok) {
    bookingsCache.set(cacheKey, []);
    return [];
  }

  const items = (res.items || []).map(it => ({
    __backendId: uidFromItem(roomKey, dateStr, it),
    roomKey,
    room: roomKeyToName[roomKey] || res.roomName || "",
    date: dateStr,
    start_time: it.start || "",
    end_time: it.end || "",
    title: it.title || "-",
    department: it.department || "",
    booker: it.booker || "",
    attendees: it.attendees || "",
    description: it.description || ""
  }));

  bookingsCache.set(cacheKey, items);
  return items;
}

async function refreshVisibleBookings() {
  const dates = getVisibleDates();
  const rooms = (currentRoomFilter === "all")
    ? ROOM_KEYS
    : [roomNameToKey[currentRoomFilter]].filter(Boolean);

  // ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô batch ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô)
  const tasks = [];
  for (const d of dates) {
    for (const rk of rooms) tasks.push({ rk, d });
  }

  const out = [];
  const concurrency = 10;
  let i = 0;

  async function worker() {
    while (i < tasks.length) {
      const idx = i++;
      const t = tasks[idx];
      try {
        const arr = await loadBookingsFor(t.rk, t.d);
        out.push(...arr);
      } catch (e) {
        // ignore per-cell error
      }
    }
  }

  await Promise.all(Array.from({ length: Math.min(concurrency, tasks.length) }, worker));
  bookings = out;
}

/* ============================================================
  VISIBLE DATES BY VIEW
============================================================ */
function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  return d;
}

function getVisibleDates() {
  if (currentView === "day") {
    return [ymd(currentDate)];
  }

  if (currentView === "week") {
    const ws = getWeekStart(currentDate);
    const arr = [];
    for (let i=0;i<7;i++) {
      const d = new Date(ws);
      d.setDate(d.getDate()+i);
      arr.push(ymd(d));
    }
    return arr;
  }

  // month: 6-week grid
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const first = new Date(year, month, 1);
  const startDay = first.getDay();
  const gridStart = new Date(first);
  gridStart.setDate(first.getDate() - startDay);
  gridStart.setHours(0,0,0,0);

  const arr = [];
  for (let i=0;i<42;i++) {
    const d = new Date(gridStart);
    d.setDate(gridStart.getDate()+i);
    arr.push(ymd(d));
  }
  return arr;
}

/* ============================================================
  FILTER
============================================================ */
function getFilteredBookings() {
  if (currentRoomFilter === 'all') return bookings;
  return bookings.filter(b => b.room === currentRoomFilter);
}

/* ============================================================
  RENDER
============================================================ */
function renderCalendar() {
  const container = document.getElementById('calendar-container');
  const monthLabel = document.getElementById('current-month');

  const thaiDays = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
  const thaiDaysFull = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

  if (currentView === 'month') {
    monthLabel.textContent = `${thaiMonths[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
    container.innerHTML = renderMonthView(thaiDays);
  } else if (currentView === 'week') {
    const ws = getWeekStart(currentDate);
    const we = new Date(ws); we.setDate(we.getDate()+6);
    monthLabel.textContent = `${ws.getDate()} - ${we.getDate()} ${thaiMonths[we.getMonth()]} ${we.getFullYear()+543}`;
    container.innerHTML = renderWeekView(thaiDaysFull);
  } else {
    monthLabel.textContent = `${currentDate.getDate()} ${thaiMonths[currentDate.getMonth()]} ${currentDate.getFullYear()+543}`;
    container.innerHTML = renderDayView();
  }

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å backend ‡πÅ‡∏•‡πâ‡∏ß rerender ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  (async () => {
    await refreshVisibleBookings();
    // rerender after data loaded
    if (currentView === 'month') container.innerHTML = renderMonthView(thaiDays);
    else if (currentView === 'week') container.innerHTML = renderWeekView(thaiDaysFull);
    else container.innerHTML = renderDayView();
  })();
}

function renderMonthView(thaiDays) {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay();
  const totalDays = lastDay.getDate();
  const today = new Date();

  let html = `
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="calendar-grid bg-slate-50 border-b border-slate-200">
        ${thaiDays.map(d => `<div class="p-3 text-center text-sm font-medium text-slate-600">${d}</div>`).join('')}
      </div>
      <div class="calendar-grid">
  `;

  // Empty cells before first day
  for (let i = 0; i < startDay; i++) {
    html += `<div class="min-h-[100px] p-2 border-b border-r border-slate-100 bg-slate-50"></div>`;
  }

  // Days
  for (let day = 1; day <= totalDays; day++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;

    const dayBookings = getFilteredBookings().filter(b => b.date === dateStr);

    html += `
      <div class="min-h-[100px] p-2 border-b border-r border-slate-100 hover:bg-slate-50 transition cursor-pointer"
           onclick="openBookingModal('${dateStr}')">
        <div class="flex items-center justify-between mb-1">
          <span class="${isToday ? 'w-7 h-7 flex items-center justify-center rounded-full bg-emerald-200 text-emerald-900 text-sm font-medium' : 'text-sm text-slate-700'}">${day}</span>
        </div>
        <div class="space-y-1">
          ${dayBookings.slice(0,3).map(b => `
            <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')"
                 class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-2 py-1 rounded text-xs truncate cursor-pointer">
              <span class="font-medium">${b.start_time}</span> ${b.title}
            </div>
          `).join('')}
          ${dayBookings.length > 3 ? `<div class="text-xs text-slate-500 pl-2">+${dayBookings.length-3} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>` : ''}
          ${dayBookings.length === 0 ? `<div class="text-xs text-slate-300 pl-2">‚Äî</div>` : ''}
        </div>
      </div>
    `;
  }

  // Empty cells after last day
  const remainingCells = (7 - ((startDay + totalDays) % 7)) % 7;
  for (let i = 0; i < remainingCells; i++) {
    html += `<div class="min-h-[100px] p-2 border-b border-r border-slate-100 bg-slate-50"></div>`;
  }

  html += `</div></div>`;
  return html;
}

function renderWeekView(thaiDaysFull) {
  const weekStart = getWeekStart(currentDate);
  const today = new Date();
  const todayStr = ymd(today);

  let html = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">`;

  html += `<div class="grid grid-cols-8 border-b border-slate-200 bg-slate-50">`;
  html += `<div class="p-3 text-center text-sm font-medium text-slate-600 border-r border-slate-200">‡πÄ‡∏ß‡∏•‡∏≤</div>`;

  for (let i=0;i<7;i++) {
    const d = new Date(weekStart); d.setDate(d.getDate()+i);
    const ds = ymd(d);
    const isToday = ds === todayStr;
    html += `
      <div class="p-3 text-center border-r border-slate-200 ${isToday ? 'bg-emerald-50' : ''}">
        <div class="text-xs text-slate-500">${thaiDaysFull[i]}</div>
        <div class="${isToday ? 'w-8 h-8 mx-auto flex items-center justify-center rounded-full bg-emerald-200 text-emerald-900 font-semibold' : 'font-semibold text-slate-700'}">${d.getDate()}</div>
      </div>
    `;
  }
  html += `</div>`;

  html += `<div class="overflow-y-auto" style="max-height: 500px;">`;
  for (let h=7;h<=20;h++) {
    html += `<div class="grid grid-cols-8 border-b border-slate-100">`;
    html += `<div class="p-2 text-xs text-slate-500 text-center border-r border-slate-100 bg-slate-50">${String(h).padStart(2,'0')}:00</div>`;

    for (let i=0;i<7;i++) {
      const d = new Date(weekStart); d.setDate(d.getDate()+i);
      const ds = ymd(d);

      const hourBookings = getFilteredBookings().filter(b => {
        if (b.date !== ds) return false;
        const sh = parseInt(b.start_time.split(':')[0],10);
        return sh === h;
      });

      html += `
        <div class="p-1 min-h-[60px] border-r border-slate-100 time-slot"
             onclick="openBookingModal('${ds}', '${String(h).padStart(2,'0')}:00')">
          ${hourBookings.map(b => `
            <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')"
                 class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-2 py-1 rounded text-xs mb-1 cursor-pointer">
              <div class="font-medium truncate">${b.title}</div>
              <div class="text-slate-500">${b.start_time}-${b.end_time}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    html += `</div>`;
  }
  html += `</div></div>`;
  return html;
}

function renderDayView() {
  const dateStr = ymd(currentDate);
  const rooms = ['Mind Room','Reality Room','Power Room','Space Room'];
  const filteredRooms = (currentRoomFilter === 'all') ? rooms : [currentRoomFilter];

  let html = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">`;

  html += `<div class="grid border-b border-slate-200 bg-slate-50" style="grid-template-columns: 60px repeat(${filteredRooms.length}, 1fr);">`;
  html += `<div class="p-3 text-center text-sm font-medium text-slate-600 border-r border-slate-200">‡πÄ‡∏ß‡∏•‡∏≤</div>`;

  filteredRooms.forEach(room => {
    html += `
      <div class="p-3 text-center border-r border-slate-200">
        <div class="flex items-center justify-center gap-2">
          <span class="w-3 h-3 rounded-full ${roomColors[room].class}"></span>
          <span class="font-medium text-slate-700">${room}</span>
        </div>
      </div>
    `;
  });

  html += `</div>`;

  html += `<div class="overflow-y-auto" style="max-height: 500px;">`;
  for (let h=7;h<=20;h++) {
    html += `<div class="grid border-b border-slate-100" style="grid-template-columns: 60px repeat(${filteredRooms.length}, 1fr);">`;
    html += `<div class="p-2 text-xs text-slate-500 text-center border-r border-slate-100 bg-slate-50">${String(h).padStart(2,'0')}:00</div>`;

    filteredRooms.forEach(room => {
      const hourBookings = bookings.filter(b => {
        if (b.date !== dateStr || b.room !== room) return false;
        const sh = parseInt(b.start_time.split(':')[0],10);
        return sh === h;
      });

      html += `
        <div class="p-1 min-h-[60px] border-r border-slate-100 time-slot"
             onclick="openBookingModal('${dateStr}', '${String(h).padStart(2,'0')}:00', '${room}')">
          ${hourBookings.map(b => `
            <div onclick="event.stopPropagation(); viewBooking('${b.__backendId}')"
                 class="booking-card ${roomColors[b.room]?.light || 'bg-slate-100'} px-2 py-1 rounded text-xs mb-1 cursor-pointer">
              <div class="font-medium truncate">${b.title}</div>
              <div class="text-slate-500">${b.start_time}-${b.end_time}</div>
            </div>
          `).join('')}
        </div>
      `;
    });

    html += `</div>`;
  }
  html += `</div></div>`;
  return html;
}

/* ============================================================
  NAV
============================================================ */
function navigateMonth(direction) {
  if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + direction);
  else if (currentView === 'week') currentDate.setDate(currentDate.getDate() + direction*7);
  else currentDate.setDate(currentDate.getDate() + direction);
  renderCalendar();
}
function goToToday() { currentDate = new Date(); renderCalendar(); }
function changeView(view) { currentView = view; renderCalendar(); }
function filterByRoom(room) { currentRoomFilter = room; renderCalendar(); }

/* ============================================================
  DATE PICKER
============================================================ */
function toggleDatePicker() {
  const picker = document.getElementById('date-picker');
  picker.classList.toggle('hidden');
  if (!picker.classList.contains('hidden')) updatePickerMonth();
}
function updatePickerMonth() {
  const year = pickerDate.getFullYear();
  const month = pickerDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay();
  const totalDays = lastDay.getDate();
  const today = new Date();
  const selectedDate = document.getElementById('booking-date').value;

  document.getElementById('picker-month-label').textContent = `${thaiMonths[month]} ${year + 543}`;

  let html = '';
  for (let i = 0; i < startDay; i++) html += `<div class="date-picker-day other-month"></div>`;

  for (let day=1; day<=totalDays; day++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
    const isSelected = selectedDate === dateStr;

    let classes = 'date-picker-day';
    if (isSelected) classes += ' selected';
    if (isToday) classes += ' today';

    html += `<button type="button" class="${classes}" onclick="selectDate('${dateStr}'); event.preventDefault();">${day}</button>`;
  }

  const remainingCells = (7 - ((startDay + totalDays) % 7)) % 7;
  for (let i=0;i<remainingCells;i++) html += `<div class="date-picker-day other-month"></div>`;

  document.getElementById('date-picker-grid').innerHTML = html;
}
function prevPickerMonth() { pickerDate.setMonth(pickerDate.getMonth()-1); updatePickerMonth(); }
function nextPickerMonth() { pickerDate.setMonth(pickerDate.getMonth()+1); updatePickerMonth(); }
function selectDate(dateStr) {
  document.getElementById('booking-date').value = dateStr;
  document.getElementById('booking-date-display').value = formatDateDisplay(dateStr);
  document.getElementById('date-picker').classList.add('hidden');
  checkConflict();
}

/* ============================================================
  MODAL
============================================================ */
function openBookingModal(date=null, time=null, room=null) {
  document.getElementById('modal-title').textContent = '‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°';
  document.getElementById('booking-form').reset();
  document.getElementById('booking-id').value = '';
  document.getElementById('conflict-warning').classList.add('hidden');
  document.getElementById('date-picker').classList.add('hidden');

  const d = date || new Date().toISOString().split('T')[0];
  document.getElementById('booking-date').value = d;
  document.getElementById('booking-date-display').value = formatDateDisplay(d);
  pickerDate = new Date(d);

  if (time) {
    document.getElementById('booking-start').value = time;
    const endHour = parseInt(time.split(':')[0],10) + 1;
    document.getElementById('booking-end').value = `${String(endHour).padStart(2,'0')}:00`;
  } else {
    document.getElementById('booking-start').value = '09:00';
    document.getElementById('booking-end').value = '10:00';
  }

  if (room) {
    const radioBtn = document.querySelector(`input[name="room"][value="${room}"]`);
    if (radioBtn) radioBtn.checked = true;
  }

  document.getElementById('booking-modal').classList.remove('hidden');
  document.getElementById('booking-modal').classList.add('flex');

  // preload bookings for that day to make conflict accurate
  (async () => {
    const rooms = (room ? [roomNameToKey[room]] : (currentRoomFilter==="all" ? ROOM_KEYS : [roomNameToKey[currentRoomFilter]])).filter(Boolean);
    for (const rk of rooms) await loadBookingsFor(rk, d);
    // update global list so conflict checks use newest cache
    await refreshVisibleBookings();
    checkConflict();
  })();
}

function closeBookingModal() {
  document.getElementById('booking-modal').classList.add('hidden');
  document.getElementById('booking-modal').classList.remove('flex');
  document.getElementById('date-picker').classList.add('hidden');
}

/* ============================================================
  CONFLICT CHECK (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• cache/visible)
============================================================ */
function checkConflict() {
  const date = document.getElementById('booking-date').value;
  const start = document.getElementById('booking-start').value;
  const end = document.getElementById('booking-end').value;
  const room = document.querySelector('input[name="room"]:checked')?.value;

  if (!date || !start || !end || !room) {
    document.getElementById('conflict-warning').classList.add('hidden');
    return false;
  }

  const hasConflict = bookings.some(b => {
    if (b.date !== date || b.room !== room) return false;
    return (start < b.end_time && end > b.start_time);
  });

  document.getElementById('conflict-warning').classList.toggle('hidden', !hasConflict);
  return hasConflict;
}

/* ============================================================
  SUBMIT -> Backend createmeeting
============================================================ */
async function handleBookingSubmit(e) {
  e.preventDefault();

  if (checkConflict()) {
    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
    return;
  }

  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="animate-spin">‚è≥</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  const bookerEmail = document.getElementById('booking-booker-email').value.trim();
  const title = document.getElementById('booking-title').value.trim();
  const room = document.querySelector('input[name="room"]:checked')?.value;
  const date = document.getElementById('booking-date').value;
  const startTime = document.getElementById('booking-start').value;
  const endTime = document.getElementById('booking-end').value;
  const attendees = document.getElementById('booking-attendees').value.trim();
  const description = document.getElementById('booking-description').value.trim();

  try {
    if (!roomNameToKey[room]) throw new Error("INVALID_ROOM");
    const roomKey = roomNameToKey[room];

    const startIso = toLocalIso(date, startTime);
    const endIso = toLocalIso(date, endTime);

    const res = await apiJsonp("createmeeting", {
      roomKey,
      title,
      start: startIso,
      end: endIso,
      attendees,
      description,
      bookerEmail
    });

    if (!res || !res.ok) {
      const msg = res?.error ? `‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.error}` : '‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      showToast(msg);
    } else {
      showToast('‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      // clear cache for that room+date and reload
      bookingsCache.delete(`${roomKey}|${date}`);
      await refreshVisibleBookings();
      renderCalendar();
      closeBookingModal();
    }
  } catch (err) {
    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
  }

  submitBtn.disabled = false;
  submitBtn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
}

/* ============================================================
  VIEW BOOKING (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å state ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
============================================================ */
function viewBooking(id) {
  const b = bookings.find(x => x.__backendId === id);
  if (!b) return;

  selectedBooking = b;

  const info = [
    `‡∏´‡πâ‡∏≠‡∏á: ${b.room}`,
    `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateDisplay(b.date)}`,
    `‡πÄ‡∏ß‡∏•‡∏≤: ${b.start_time} - ${b.end_time}`,
    b.department ? `‡πÅ‡∏ú‡∏ô‡∏Å: ${b.department}` : '',
    b.booker ? `‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${b.booker}` : '',
    b.attendees ? `‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${b.attendees}` : '',
    b.description ? `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${b.description}` : ''
  ].filter(Boolean).join('\n');

  alert(`${b.title}\n\n${info}`);
}

/* ============================================================
  INIT
============================================================ */
async function init() {
  initTimeSelects();

  // bind events
  document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
  ['booking-date', 'booking-start', 'booking-end'].forEach(id => {
    document.getElementById(id).addEventListener('change', checkConflict);
  });
  document.querySelectorAll('input[name="room"]').forEach(input => input.addEventListener('change', checkConflict));

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative')) {
      document.getElementById('date-picker').classList.add('hidden');
    }
  });

  // ping backend
  const statusEl = document.getElementById("api-status");
  try {
    const ping = await apiJsonp("ping", {});
    if (ping && ping.ok) {
      statusEl.textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ TZ: ${ping.tz || ''} ‚Ä¢ SheetTZ: ${ping.spreadsheetTimeZone || ''}`;
      statusEl.className = "text-[11px] text-emerald-600 mt-0.5";
    } else {
      statusEl.textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (API KEY/Deploy?)`;
      statusEl.className = "text-[11px] text-red-600 mt-0.5";
    }
  } catch(e) {
    statusEl.textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Network/CORS/Deploy)`;
    statusEl.className = "text-[11px] text-red-600 mt-0.5";
  }

  renderCalendar();
}

init();
</script>
</body>
</html>
