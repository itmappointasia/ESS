<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Booking Test (GitHub Pages → Apps Script JSONP)</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; padding:16px; line-height:1.4}
    label{display:inline-block; min-width:140px}
    input,select{padding:6px 8px; min-width:360px}
    button{padding:8px 12px; cursor:pointer; margin-right:8px}
    pre{background:#111; color:#0f0; padding:10px; border-radius:8px; overflow:auto; min-height:120px}
    .row{margin:10px 0}
    .hint{color:#555; font-size:12px}
  </style>
</head>
<body>
  <h3>Room Booking Test (GitHub Pages → Apps Script JSONP)</h3>

  <div class="row">
    <label>Room:</label>
    <select id="room">
      <option value="mind">Mind Room</option>
      <option value="power">Power Room</option>
      <option value="reality">Reality Room</option>
      <option value="space">Space Room</option>
    </select>
  </div>

  <div class="row">
    <label>Title:</label>
    <input id="title" value="Test Meeting" />
  </div>

  <div class="row">
    <label>Start (ISO):</label>
    <input id="start" value="2026-02-12T08:00:00+07:00" />
    <div class="hint">ตัวอย่าง: 2026-02-12T08:00:00+07:00</div>
  </div>

  <div class="row">
    <label>End (ISO):</label>
    <input id="end" value="2026-02-12T09:00:00+07:00" />
    <div class="hint">ต้องมากกว่า Start</div>
  </div>

  <div class="row">
    <label>Attendees (comma):</label>
    <input id="att" value="ice.jirapon@gmail.com" />
  </div>

  <div class="row">
    <button id="ping">Ping Backend</button>
    <button id="book">Create Meeting</button>
    <button id="clear">Clear</button>
  </div>

  <pre id="out"></pre>

<script>
  // ✅ ต้องเป็น /exec
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxLp9bB6QHjPZ8KRf1FqGJ5am-ubfJqHE2pxgCx_sZEHnOEX8wjIukDCupjOmC9wSow/exec";
  const API_KEY = "ESS-ROOM-2026";

  const outEl = document.getElementById("out");
  const log = (m) => { outEl.textContent += m + "\n"; };
  const reset = () => { outEl.textContent = ""; };

  function jsonpCall(params){
    reset();

    // สร้าง callback ชื่อปลอดภัย
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;

    // timeout กันเงียบ
    const timer = setTimeout(() => {
      log("TIMEOUT: ไม่มี callback กลับมา (เช็ค Deploy/Permission/URL)");
      cleanup();
    }, 12000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch(_){}
    }

    window[cb] = (res) => {
      log("CALLBACK HIT:");
      log(JSON.stringify(res, null, 2));
      cleanup();

      if (res && res.ok) alert("OK");
      else alert("FAIL: " + (res && res.error ? res.error : "unknown"));
    };

    const qs = new URLSearchParams();
    Object.entries(params).forEach(([k,v]) => {
      if (v === undefined || v === null) return;
      qs.set(k, String(v));
    });

    // ✅ แสดง REQUEST ชัดๆ
    const url = `${WEBAPP_URL}?${qs.toString()}&_=${Date.now()}`;
    log("REQUEST:");
    log(url);

    const s = document.createElement("script");
    s.src = url;
    s.onerror = () => {
      log("SCRIPT ERROR: โหลดสคริปต์ไม่สำเร็จ (มักเป็น 404/permission/deploy)");
      cleanup();
      alert("SCRIPT ERROR");
    };
    document.body.appendChild(s);
  }

  document.getElementById("ping").onclick = () => {
    jsonpCall({
      action: "ping",              // ✅ ต้องเป็น ping
      apiKey: API_KEY
    });
  };

  document.getElementById("book").onclick = () => {
    const roomKey = document.getElementById("room").value;
    const title = document.getElementById("title").value;
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    const attendees = document.getElementById("att").value;

    if (!start || !end) {
      reset();
      log("ERROR: กรุณาใส่ Start/End ISO ให้ครบ");
      alert("ใส่ Start/End ก่อน");
      return;
    }

    jsonpCall({
      action: "createmeeting",     // ✅ สำคัญ: ต้องเป็น createmeeting (ตัวเล็กติดกัน)
      apiKey: API_KEY,
      roomKey,
      title,
      start,
      end,
      attendees,
      description: "Created from GitHub Pages"
    });
  };

  document.getElementById("clear").onclick = () => reset();
</script>
</body>
</html>
